<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>المسبحة الفاخرة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;900&family=Amiri:wght@700&display=swap" rel="stylesheet" />
<style>
:root{
  --navy1:#0a1931; --navy2:#102542;
  --gold1:#d4af37; --gold2:#f9e79f;
  --white:#ffffff;
  /* قيم آمنة للحافة العلوية */
  --SAFE-TOP: env(safe-area-inset-top);
  --APPBAR-H: calc(70px + var(--SAFE-TOP, 0px));
}

/* أساسيات */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Cairo",sans-serif;
  background:linear-gradient(160deg,var(--navy1),var(--navy2));
  color:var(--white);
  -webkit-tap-highlight-color:transparent;
}

/* هيدر ثابت */
.appbar{
  position:fixed; inset-inline:0; top:0; z-index:9999;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  height:var(--APPBAR-H);
  padding: calc(10px + var(--SAFE-TOP, 0px)) 16px 10px 16px;
  background:linear-gradient(180deg,rgba(10,25,49,.98),rgba(16,37,66,.85));
}
.appbar .title{
  font-weight:900; font-size:22px;
  background:linear-gradient(90deg,var(--gold1),var(--gold2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  white-space:nowrap;
}
.icon-btn{
  width:50px; height:50px; border-radius:50%; cursor:pointer;
  background:radial-gradient(circle at 30% 30%, #1b2c49, #0a1931);
  border:2px solid var(--gold1);
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 0 12px rgba(212,175,55,.6), inset 0 0 8px rgba(0,0,0,.3);
  outline:none!important;
}
.icon-btn svg{ width:28px; height:28px; stroke:var(--gold2); stroke-width:2.8; fill:none; overflow:visible }

@media (max-height:720px){ :root{ --APPBAR-H: calc(88px + var(--SAFE-TOP,0px)); } }
@media (max-width:360px){ .icon-btn{width:46px;height:46px} .icon-btn svg{width:24px;height:24px} }

/* مساحة تحت الهيدر */
.header-spacer{ height:var(--APPBAR-H) }

/* بطاقة التطبيق */
.container{ display:grid; place-items:center; padding:8px }
.screen{
  width:min(480px,100%);
  background:linear-gradient(180deg,var(--navy1),var(--navy2));
  border-radius:28px;
  box-shadow:0 25px 70px rgba(0,0,0,.6);
  overflow:hidden;
  display:flex; flex-direction:column;
}

/* تبويبات */
.tabs{display:flex; gap:12px; justify-content:center; padding:12px 16px}
.tab{
  flex:1; padding:12px; border-radius:14px; cursor:pointer; text-align:center;
  background:rgba(255,255,255,.08);
  border:2px solid rgba(212,175,55,.4);
  color:#d6dbff; font-weight:800; outline:none!important;
}
.tab.active{ background:linear-gradient(145deg,var(--gold1),var(--gold2)); color:var(--navy1) }

/* أزرار العدّ المباشر */
.quick-actions{
  display:flex; gap:10px; justify-content:center;
  padding:0 16px 6px;
}
.qa{
  flex:1; padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer;
  border:2px solid transparent; text-align:center;
}
.qa-gold{
  background:linear-gradient(145deg,var(--gold1),var(--gold2));
  color:var(--navy1); box-shadow:0 0 14px rgba(212,175,55,.35);
}
.qa-outline{
  background:rgba(255,255,255,.06);
  border-color:rgba(212,175,55,.4); color:#e8eaf3;
}
.qa:focus-visible{
  outline:3px solid rgba(212,175,55,.5);
  outline-offset:2px;
}

/* الذكر والعداد */
.phrase{ text-align:center; font-size:40px; font-weight:900; margin:12px 0 }
.counter{
  width:86%; margin:10px auto; display:flex; justify-content:space-between;
  padding:12px 20px; border-radius:16px; border:2px solid var(--gold1);
  background:linear-gradient(145deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
  font-size:26px; font-weight:900; color:var(--gold2)
}

/* المؤشر */
.ring-wrap{ width:86%; aspect-ratio:1/1; margin:18px auto; position:relative }
.outer-ring{
  position:absolute; inset:0; border-radius:50%;
  background:conic-gradient(var(--gold1) var(--deg,0deg), rgba(255,255,255,.14) 0);
  box-shadow:0 0 25px rgba(212,175,55,.35), inset 0 0 30px rgba(0,0,0,.7);
}
.ticks{
  position:absolute; inset:8px; border-radius:50%;
  background:repeating-conic-gradient(var(--gold1) 0deg 2deg, transparent 2deg 10deg);
  -webkit-mask:radial-gradient(circle, transparent 78%, #000 79%);
  opacity:.35;
}

/* زر اضغط */
.center-btn{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:70%; height:70%; border-radius:50%;
  background:radial-gradient(circle at 30% 30%, var(--white), var(--gold2), var(--gold1));
  border:3px solid var(--gold1);
  display:grid; place-items:center;
  font-family:"Amiri","Tahoma",serif; font-weight:700; font-size:clamp(26px,5.2vw,34px); color:var(--navy1);
  cursor:pointer;
  box-shadow:0 0 35px rgba(212,175,55,.65);
  transition:transform .1s, box-shadow .25s ease;
  outline:none!important;
}
.center-btn:active{ transform:translate(-50%,-50%) scale(.95) }
.glow{ box-shadow:0 0 55px 20px rgba(212,175,55,.85)!important }

/* الحديث والمصدر */
.hadith-box{
  background:linear-gradient(160deg,rgba(255,255,255,.10),rgba(255,255,255,.05));
  border:2px solid var(--gold1);
  border-radius:16px;
  margin:8px 16px 10px;
  padding:16px;
  color:#f7f8fb;
  text-align:center;
}
.hadith-title{ color:var(--gold2); font-weight:900; margin-bottom:10px; font-size:16px }
.hadith-text{ font-size:16px; line-height:1.85 }

.source-box{
  background:linear-gradient(160deg,rgba(255,255,255,.08),rgba(255,255,255,.04));
  border:2px dashed var(--gold1);
  border-radius:12px;
  margin:6px 16px 12px;
  padding:10px 14px;
  color:#e8eaf3; font-size:14px; text-align:center;
}
.source-title{ color:var(--gold2); font-weight:800; margin-bottom:4px }

/* تذييل التوقيع */
.credit{
  margin:6px 16px 18px;
  text-align:center;
  font-size:13px;
  color:#f1e9c9;
  opacity:.9;
  border-top:1px dashed rgba(212,175,55,.5);
  padding-top:10px;
}

/* تركيز واضح بدلاً من الإلغاء الكامل */
.icon-btn:focus-visible,
.tab:focus-visible,
.center-btn:focus-visible{
  outline: 3px solid rgba(212,175,55,.85);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(212,175,55,.25);
}

/* احترام تقليل الحركة */
@media (prefers-reduced-motion: reduce){
  .center-btn, .icon-btn{ transition: none !important; animation: none !important; }
}

/* ===================== مودال التصفير ===================== */
.modal-backdrop{
  position:fixed; inset:0; z-index:10000; /* فوق الهيدر */
  background:rgba(0,0,0,.55);
  display:none; align-items:center; justify-content:center;
  padding:16px;
}
.modal-backdrop.show{ display:flex; animation:fadeIn .18s ease }
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }

.modal-card{
  width:min(420px,100%);
  background:linear-gradient(160deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  border:2px solid var(--gold1);
  border-radius:18px;
  box-shadow:0 18px 60px rgba(0,0,0,.6);
  padding:18px;
  text-align:center;
  color:#f7f8fb;
}
.modal-icon{
  width:64px; height:64px; border-radius:50%;
  margin:0 auto 10px;
  display:grid; place-items:center;
  color:var(--gold2);
  background:radial-gradient(circle at 30% 30%, #1b2c49, #0a1931);
  border:2px solid var(--gold1);
  box-shadow:0 0 12px rgba(212,175,55,.5), inset 0 0 8px rgba(0,0,0,.3);
}
.modal-icon svg{ width:36px; height:36px }
.modal-title{
  font-weight:900; font-size:20px;
  background:linear-gradient(90deg,var(--gold1),var(--gold2));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  margin:6px 0 4px;
}
.modal-text{ opacity:.95; font-size:15px; margin-bottom:10px }
.modal-opt{
  display:flex; align-items:center; gap:8px; justify-content:center;
  font-size:14px; color:#f1e9c9; margin:6px 0 12px;
}
.modal-actions{ display:flex; gap:10px; justify-content:center }
.btn{
  min-width:120px; padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
  border:2px solid transparent;
}
.btn-outline{
  background:rgba(255,255,255,.06);
  border-color:rgba(212,175,55,.4); color:#e8eaf3;
}
.btn-outline:focus-visible{ outline:3px solid rgba(212,175,55,.5) }
.btn-gold{
  background:linear-gradient(145deg,var(--gold1),var(--gold2));
  color:var(--navy1);
  box-shadow:0 0 14px rgba(212,175,55,.35);
}

/* ===================== Toast ===================== */
.toast{
  position:fixed; left:50%; transform:translateX(-50%) translateY(20px);
  bottom:18px; z-index:10001;
  background:linear-gradient(160deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  color:#f7f8fb; border:2px solid var(--gold1); border-radius:12px;
  padding:10px 14px; font-size:14px; box-shadow:0 10px 40px rgba(0,0,0,.5);
  opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
}
.toast.show{ opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0) }
.toast .undo{
  margin-inline-start:10px; background:transparent; border:none; color:var(--gold2);
  font-weight:900; cursor:pointer; text-decoration:underline;
}
@media (prefers-reduced-motion: reduce){
  .modal-backdrop.show{ animation:none }
  .toast{ transition:none }
}
</style>
</head>
<body>

<!-- هيدر ثابت -->
<div class="appbar" role="banner" aria-label="التحكم">
  <button class="icon-btn" id="btn-reset" title="إعادة">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M3 12a9 9 0 1 0 3-6.7M3 4v4h4"/>
    </svg>
  </button>
  <div class="title">المسبحة</div>
  <button class="icon-btn" id="btn-next" title="التالي">
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M9 6l6 6-6 6"/>
    </svg>
  </button>
</div>

<!-- مسافة تحت الهيدر -->
<div class="header-spacer" aria-hidden="true"></div>

<!-- بطاقة التطبيق -->
<div class="container">
  <div class="screen" role="application" aria-label="المسبحة">
    <div class="tabs" role="tablist" aria-label="أنماط التسبيح">
      <button id="tabZ" class="tab active" role="tab" aria-selected="true" aria-controls="panel">تسبيح الزهراء</button>
      <button id="tabO" class="tab" role="tab" aria-selected="false" aria-controls="panel">التسبيح المفتوح</button>
    </div>

    <!-- ✅ أزرار العدّ المباشر -->
    <div class="quick-actions" aria-label="أزرار عدّ مباشرة">
      <button class="qa qa-gold" id="qaZ" type="button" aria-label="عدّ تسبيح الزهراء">تسبيح الزهراء +1</button>
      <button class="qa qa-outline" id="qaO" type="button" aria-label="عدّ التسبيح المفتوح">التسبيح المفتوح +1</button>
    </div>

    <!-- لوحة واحدة تتبدّل محتواها مع التبويبات -->
    <div id="panel" role="tabpanel" aria-labelledby="tabZ">
      <div class="phrase" id="phrase" aria-live="polite">الله أكبر</div>

      <div class="counter" role="group" aria-label="عداد التسبيح">
        <div id="leftNum" aria-label="الهدف">34</div>
        <div id="rightNum" aria-label="المنجز">0</div>
      </div>

      <div class="ring-wrap">
        <div class="outer-ring" id="ring" aria-hidden="true"></div>
        <div class="ticks" aria-hidden="true"></div>
        <button class="center-btn" id="press" type="button" aria-label="اضغط للتسبيح">إضغط</button>
      </div>

      <div class="hadith-box" id="hadithBox"></div>
      <div class="source-box" id="sourceBox"></div>

      <!-- التذييل -->
      <div class="credit">برمجة وتطوير : فاضل الريس</div>
    </div>

    <!-- مودال تأكيد التصفير -->
    <div class="modal-backdrop" id="resetModal" role="dialog" aria-modal="true" aria-labelledby="resetTitle" aria-describedby="resetDesc">
      <div class="modal-card">
        <div class="modal-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 3-6.7M3 4v4h4" fill="none" stroke="currentColor" stroke-width="2.2"/></svg>
        </div>
        <div class="modal-title" id="resetTitle">تصفير العدّاد؟</div>
        <div class="modal-text" id="resetDesc">سيبدأ تسبيح جديد، ولن تتغيّر إعداداتك الأخرى.</div>

        <label class="modal-opt">
          <input type="checkbox" id="skipConfirm"> لا تسألني مرّة أخرى
        </label>

        <div class="modal-actions">
          <button class="btn btn-outline" id="btnCancelReset" type="button">إلغاء</button>
          <button class="btn btn-gold" id="btnDoReset" type="button">تصفير</button>
        </div>
      </div>
    </div>

    <!-- Toast مع تراجع -->
    <div class="toast" id="toast" role="status" aria-live="polite">
      تم التصفير.
      <button class="undo" id="btnUndo" type="button" aria-label="تراجع عن التصفير">تراجع</button>
    </div>
  </div>
</div>

<script>
/* أحاديث + مصادر (عشوائي كل زيارة) */
const ahadith = [
  {text:'قال الصادق (عليه السلام): من سبّح تسبيح فاطمة (عليها السلام) قبل أن يثني رجليه بعد انصرافه من صلاة الغداة غفر له، ويبدأ بالتكبير، ثمّ قال (عليه السلام) لحمزة بن حمران: حسبك بها يا حمزة.',src:'قرب الإسناد'},
  {text:'قال أبو هارون المكفوف: قال الصادق (عليه السلام): يا أبا هارون، إنّا نأمر صبياننا بتسبيح فاطمة (عليها السلام) كما نأمرهم بالصلاة فالزمه، فإنّه لم يلزمه عبد فشقي.',src:'بحار الأنوار: ج٨٢، ص٣٢٨'},
  {text:'قال الباقر (عليه السلام): من سبّح تسبيح الزهراء (عليها السلام) ثمّ استغفر غفر له، وهي مائة باللسان وألف في الميزان، وتطرد الشيطان وترضي الرحمن.',src:'ثواب الأعمال / بحار الأنوار: ج٨٢، ص٣٣٢'}
];

(function showRandomHadith(){
  const h = ahadith[Math.floor(Math.random()*ahadith.length)];
  const hb = document.getElementById('hadithBox');
  const sb = document.getElementById('sourceBox');
  hb.innerHTML = '';
  sb.innerHTML = '';

  const t = document.createElement('div');
  t.className = 'hadith-title';
  t.textContent = 'ثواب تسبيح فاطمة الزهراء (عليها السلام)';

  const tx = document.createElement('div');
  tx.className = 'hadith-text';
  tx.textContent = h.text;

  const st = document.createElement('div');
  st.className = 'source-title';
  st.textContent = 'المصدر';

  const sv = document.createElement('div');
  sv.textContent = h.src;

  hb.append(t, tx);
  sb.append(st, sv);
})();

/* إعدادات */
const SEQ=[{text:"الله أكبر",max:34},{text:"الحمد لله",max:33},{text:"سبحان الله",max:33}];
let mode='zahra';
let zh={step:0,count:0};
let op={text:'سبحان الله',count:0,target:0};

const phrase=document.getElementById('phrase'),
      left=document.getElementById('leftNum'),
      right=document.getElementById('rightNum'),
      ring=document.getElementById('ring'),
      press=document.getElementById('press'),
      tabZ=document.getElementById('tabZ'),
      tabO=document.getElementById('tabO'),
      panel=document.getElementById('panel');

/* احترام تفضيل تقليل الحركة للهزّ */
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
function vibrate(p){
  if(prefersReducedMotion) return;
  try{ navigator.vibrate && navigator.vibrate(p); }catch{}
}

/* حفظ/استرجاع الحالة */
const save = () => {
  try{ localStorage.setItem('rosary-state', JSON.stringify({mode, zh, op})); }catch{}
};
const load = () => {
  try{
    const v = JSON.parse(localStorage.getItem('rosary-state')||'null');
    if(v && v.mode && v.zh && v.op){ mode=v.mode; zh=v.zh; op=v.op; }
  }catch{}
};
load();

/* كبح درجة الحلقة إلى [0..360] */
function setRingProgress(part, whole){
  const ratio = (whole>0) ? Math.min(Math.max(part/whole, 0), 1) : 0;
  ring.style.setProperty('--deg', (ratio*360) + 'deg');
}

/* عرض */
function render(){
  if(mode==='zahra'){
    const c=SEQ[zh.step]||{text:'تم',max:1};
    phrase.textContent=c.text;
    left.textContent=c.max;
    right.textContent=zh.count;
    setRingProgress(zh.count, c.max);
    panel.setAttribute('aria-labelledby','tabZ');
  }else{
    phrase.textContent=op.text;
    left.textContent=op.target>0?op.target:'∞';
    right.textContent=op.count;
    setRingProgress(op.count, op.target);
    panel.setAttribute('aria-labelledby','tabO');
  }
  save();
}

/* نقرة التسبيح */
function tick(){
  if(mode==='zahra'){
    const c=SEQ[zh.step];
    if(c){
      zh.count++;
      if(zh.count>=c.max){
        zh.step++; zh.count=0;
        vibrate([120,60,120]);
        press.classList.add('glow'); setTimeout(()=>press.classList.remove('glow'),800);
      }
    }
    if(zh.step>=SEQ.length){
      phrase.textContent='تم التسبيح ✔';
      left.textContent='0'; right.textContent='0';
      ring.style.setProperty('--deg','360deg');
      vibrate([200,100,200]);
      press.classList.add('glow'); setTimeout(()=>press.classList.remove('glow'),1500);
    }
  }else{
    op.count++;
    if(op.target>0 && op.count>=op.target){
      vibrate([200,100,200]);
      press.classList.add('glow'); setTimeout(()=>press.classList.remove('glow'),1200);
    }
  }
  render();
}

/* تبويبات وARIA */
function setTab(active){ // 'zahra' | 'open'
  mode = active;
  const isZ = (mode==='zahra');
  tabZ.classList.toggle('active', isZ);
  tabO.classList.toggle('active', !isZ);
  tabZ.setAttribute('aria-selected', isZ);
  tabO.setAttribute('aria-selected', !isZ);
  tabZ.tabIndex = isZ ? 0 : -1;
  tabO.tabIndex = !isZ ? 0 : -1;
  render();
}

/* الضغط الأساسي داخل الحلقة */
press.addEventListener('click', tick);

/* زر التالي للتبديل */
document.getElementById('btn-next').onclick=()=> setTab(mode==='zahra' ? 'open' : 'zahra');

/* ===================== مودال/توست التصفير ===================== */
let preResetState = null;
const resetModal = document.getElementById('resetModal');
const btnCancelReset = document.getElementById('btnCancelReset');
const btnDoReset = document.getElementById('btnDoReset');
const skipConfirm = document.getElementById('skipConfirm');
const toast = document.getElementById('toast');
const btnUndo = document.getElementById('btnUndo');

let lastFocusEl = null;

function openResetModal(){
  if(localStorage.getItem('rs-noConfirm') === '1'){
    doReset(); return;
  }
  lastFocusEl = document.activeElement;
  resetModal.classList.add('show');
  btnDoReset.focus();
}
function closeResetModal(){
  resetModal.classList.remove('show');
  if(lastFocusEl) lastFocusEl.focus();
}
function showToast(){
  toast.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toast.classList.remove('show'), 5000);
}
function doReset(){
  preResetState = JSON.stringify({mode, zh, op});
  zh = {step:0, count:0};
  op = {text:'سبحان الله', count:0, target:0};
  save(); render();
  closeResetModal();
  if(skipConfirm && skipConfirm.checked) localStorage.setItem('rs-noConfirm','1');
  showToast();
}

btnCancelReset.addEventListener('click', closeResetModal);
btnDoReset.addEventListener('click', doReset);
resetModal.addEventListener('click', (e)=>{ if(e.target === resetModal) closeResetModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && resetModal.classList.contains('show')) closeResetModal(); });
btnUndo.addEventListener('click', ()=>{
  if(!preResetState) return;
  const s = JSON.parse(preResetState);
  mode = s.mode; zh = s.zh; op = s.op;
  save(); render();
  toast.classList.remove('show');
});

/* اربط زر الإعادة بالمودال */
document.getElementById('btn-reset').onclick = openResetModal;

/* تنقّل لوحة المفاتيح بالأسهم */
document.querySelector('.tabs').addEventListener('keydown', (e)=>{
  if(e.key==='ArrowRight' || e.key==='ArrowLeft'){
    e.preventDefault();
    (mode==='zahra' ? tabO : tabZ).focus();
    setTab(mode==='zahra' ? 'open' : 'zahra');
  }
});

/* ====== أزرار العدّ المباشر (+1) لكل وضع ====== */
function tickZDirect(){
  setTab('zahra');  // يعرض لوحة الزهراء
  tick();           // يعدّ ضغطة واحدة
}
function tickODirect(){
  setTab('open');   // يعرض لوحة المفتوح
  tick();           // يعدّ ضغطة واحدة
}
document.getElementById('qaZ').addEventListener('click', tickZDirect);
document.getElementById('qaO').addEventListener('click', tickODirect);

/* تشغيل أولي */
setTab(mode); // يضبط ARIA ويستدعي render
</script>
</body>
</html>
