<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ â€” ØªÙ‚Ø¯ÙŠØ± Ø±Ø³Ù…ÙŠ (UN/WB)</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f6f8; --ink:#111827; --muted:#6b7280;
    --card:#ffffff; --line:#e5e7eb;
    --gold:#b58900; --gold-soft:#f5d574;
    --ocean:#0b4d8a; --emerald:#059669; --crimson:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:"Cairo",sans-serif; background:var(--bg); color:var(--ink)}
  header{text-align:center; padding:24px 12px}
  .brand{font-family:"Amiri",serif; font-size:clamp(26px,4.5vw,42px); color:var(--gold)}
  .tag{margin-top:6px; font-size:14px; color:#6b7280}
  .shell{max-width:980px; margin:0 auto; padding:0 16px}
  .hero{background:var(--card); border:1px solid var(--line); border-radius:20px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05)}
  .row{display:grid; gap:16px}
  @media(min-width:920px){ .row{grid-template-columns:1.2fr .8fr} }
  .field{display:flex; flex-direction:column; gap:8px; margin-bottom:12px}
  .center{text-align:center}
  .date-grid{display:flex; justify-content:center; gap:8px; flex-wrap:wrap}
  .date-grid input[type="number"]{
    width:110px; padding:10px; border:1px solid var(--line); border-radius:10px; text-align:center; font-family:monospace;
  }
  .seg{display:flex; gap:6px; justify-content:center; flex-wrap:wrap}
  .seg button{flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--line); background:#f9fafb; cursor:pointer; max-width:160px}
  .seg button.on{background:var(--gold); color:#fff; border-color:var(--gold)}
  .btn{padding:12px 20px; border-radius:10px; border:none; cursor:pointer; background:linear-gradient(90deg,var(--gold),var(--gold-soft)); color:#111; font-weight:700; display:block; margin:0 auto}
  .badge{display:inline-block; padding:10px 14px; border-radius:10px; margin-top:12px}
  .ok{background:#eff6ff; color:var(--ocean)}

  .kpi{display:grid; gap:10px; grid-template-columns:repeat(2,1fr); margin-top:10px}
  .k{background:#f9fafb; border:1px solid var(--line); border-radius:10px; padding:10px; text-align:center}
  .k .v{font-weight:700; font-size:18px}

  .eqwrap{display:none; margin-top:8px}
  .eqbox{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px; text-align:center}
  .eqbox .v{font-weight:700; font-size:16px; margin-bottom:4px; color:#111}
  .eqbox .l{font-size:12px; color:#6b7280}

  .deck{display:grid; gap:12px; grid-template-columns:1fr; margin-top:16px}
  @media(min-width:860px){ .deck{grid-template-columns:repeat(3,1fr)} }
  .card{background:#fdfdfd; border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .card h3{margin:0 0 6px; font-family:"Amiri",serif; color:var(--gold)}
  .card p, .card ul{margin:0; font-size:14px; color:#374151; line-height:1.6}
  .card ul{margin-top:8px; padding-inline-start:20px}

  .counter{ margin:14px auto 0; max-width:720px;
    background:linear-gradient(90deg, #fff7e6, #fff); border:1px solid #f3e8c8; border-radius:16px; padding:12px;
    box-shadow:0 4px 12px rgba(0,0,0,.05) }
  .counter.alt{ background:linear-gradient(90deg, #eef6ff, #fff); border-color:#cfe6ff }
  .counter h4{margin:0 0 8px; font-family:"Amiri",serif; color:#8b6a00; text-align:center}
  .counter.alt h4{color:#0b4d8a}
  .cflex{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .cbox{min-width:110px; padding:10px 12px; border:1px solid var(--line); background:#fff; border-radius:12px; text-align:center}
  .cbox .num{font-weight:800; font-size:22px}
  .cbox .lbl{font-size:12px; color:#6b7280}

  /* Ù…Ø´Ø§Ø±ÙƒØ© */
  .sharewrap{margin:16px 0; text-align:center}
  .share-title{font-family:"Amiri",serif; color:var(--gold); margin-bottom:8px; cursor:pointer; display:inline-block}
  .share-title:hover{text-decoration:underline}
  .sharebar{display:flex; justify-content:center; gap:8px; flex-wrap:wrap}
  .iconbtn{width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; border:1px solid var(--line); background:#fff; cursor:pointer}
  .iconbtn svg{width:18px; height:18px; fill:#374151}

  footer{text-align:center; margin:12px 0 24px; font-size:12px; color:#6b7280}
  .ghost-link{color:inherit; text-decoration:none; cursor:default}

  /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
  .select{ position:relative; display:inline-block; width:100% }
  .select select{
    width:100%; appearance:none; background:#fff; border:1px solid var(--gold); border-radius:10px;
    padding:10px 42px 10px 12px; font-size:1rem; cursor:pointer; color:#111; transition:.15s; text-align:right; box-shadow:0 1px 0 rgba(0,0,0,.02)
  }
  .select select:hover{ box-shadow:0 0 0 3px rgba(245,213,116,.15) }
  .select select:focus{ outline:none; border-color:var(--gold); box-shadow:0 0 0 3px rgba(245,213,116,.35) }
  .select::after{
    content:""; position:absolute; top:50%; transform:translateY(-50%); right:12px; width:18px; height:18px;
    background:linear-gradient(135deg,var(--gold),var(--gold-soft));
    -webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="black" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.08 1.04l-4.24 4.38a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>') center/contain no-repeat;
    mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="black" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.08 1.04l-4.24 4.38a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z"/></svg>') center/contain no-repeat;
    pointer-events:none; opacity:.95;
  }

  /* Ø¥Ø´Ø¹Ø§Ø± Ø£Ù†ÙŠÙ‚ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ */
  .notice{
    position:fixed; left:50%; bottom:20px; transform:translateX(-50%) translateY(10px);
    background:#fff; border:1px solid var(--gold); border-radius:12px; padding:10px 14px;
    box-shadow:0 8px 24px rgba(0,0,0,.12); display:flex; align-items:center; gap:10px;
    opacity:0; transition:.25s ease; z-index:9999; max-width:92vw; font-size:14px; color:#111;
  }
  .notice.show{ opacity:1; transform:translateX(-50%) translateY(0) }
  .notice .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(90deg,var(--gold),var(--gold-soft))}
  .notice .close{ margin-inline-start:8px; cursor:pointer; border:none; background:transparent; font-size:18px; line-height:1; color:#6b7280 }
  .notice.error{ border-color:#fecaca }
  .notice.error .dot{ background:linear-gradient(90deg,#fecaca,#fee2e2) }

  /* Ø²Ø± ØªÙ†Ø²ÙŠÙ„ PDF */
  .pdfwrap{margin-top:12px; text-align:center; display:none}
  .pdfbtn{padding:10px 16px; border-radius:10px; border:1px solid var(--gold); background:#fff; cursor:pointer; font-weight:700}
  .pdfbtn:hover{ box-shadow:0 0 0 3px rgba(245,213,116,.15) }
</style>
</head>
<body>
<header>
  <div class="brand">Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ</div>
  <div class="tag">Ø§Ù„Ù‚ÙŠÙ… ØªÙØ¬Ù„Ø¨ Ø¢Ù„ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¯ÙˆÙ„ÙŠ (UN WPP) Ù„ÙƒÙ„ Ø¯ÙˆÙ„Ø© ÙˆØ¬Ù†Ø³. Ø£Ø¶ÙÙ Ø¹ÙˆØ§Ù…Ù„ Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠØ± Ø´Ø®ØµÙŠ ØªÙ‚Ø±ÙŠØ¨ÙŠ.</div>
</header>

<main class="shell">
  <section class="hero">
    <div class="row">
      <div>
        <!-- Ø§Ù„ØªØ§Ø±ÙŠØ® -->
        <div class="field center">
          <label><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</strong></label>
          <div class="date-grid" dir="ltr">
            <input id="d" type="number" inputmode="numeric" placeholder="Ø§Ù„ÙŠÙˆÙ…"  min="1"  max="31"  autocomplete="off"/>
            <input id="m" type="number" inputmode="numeric" placeholder="Ø§Ù„Ø´Ù‡Ø±" min="1"  max="12"  autocomplete="off"/>
            <input id="y" type="number" inputmode="numeric" placeholder="Ø§Ù„Ø³Ù†Ø©" min="1900" max="2100" autocomplete="off"/>
          </div>
        </div>

        <!-- Ø§Ù„Ø¯ÙˆÙ„Ø© -->
        <div class="field center">
          <label><strong>Ø§Ù„Ø¯ÙˆÙ„Ø©</strong></label>
          <div class="select">
            <select id="countrySelect" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©">
              <option value="DZA">Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±</option>
              <option value="BHR" selected>Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†</option>
              <option value="COM">Ø¬Ø²Ø± Ø§Ù„Ù‚Ù…Ø±</option>
              <option value="DJI">Ø¬ÙŠØ¨ÙˆØªÙŠ</option>
              <option value="EGY">Ù…ØµØ±</option>
              <option value="IRQ">Ø§Ù„Ø¹Ø±Ø§Ù‚</option>
              <option value="JOR">Ø§Ù„Ø£Ø±Ø¯Ù†</option>
              <option value="KWT">Ø§Ù„ÙƒÙˆÙŠØª</option>
              <option value="LBN">Ù„Ø¨Ù†Ø§Ù†</option>
              <option value="LBY">Ù„ÙŠØ¨ÙŠØ§</option>
              <option value="MRT">Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§</option>
              <option value="MAR">Ø§Ù„Ù…ØºØ±Ø¨</option>
              <option value="OMN">Ø¹ÙÙ…Ø§Ù†</option>
              <option value="PSE">ÙÙ„Ø³Ø·ÙŠÙ†</option>
              <option value="QAT">Ù‚Ø·Ø±</option>
              <option value="SAU">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</option>
              <option value="SOM">Ø§Ù„ØµÙˆÙ…Ø§Ù„</option>
              <option value="SDN">Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</option>
              <option value="SYR">Ø³ÙˆØ±ÙŠØ§</option>
              <option value="TUN">ØªÙˆÙ†Ø³</option>
              <option value="ARE">Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©</option>
              <option value="YEM">Ø§Ù„ÙŠÙ…Ù†</option>
              <option value="IRN">Ø¥ÙŠØ±Ø§Ù†</option>
            </select>
          </div>
        </div>

        <!-- Ø§Ù„Ù†ÙˆØ¹ -->
        <div class="field center">
          <label><strong>Ø§Ù„Ù†ÙˆØ¹</strong></label>
          <div class="seg" id="sexSeg">
            <button type="button" class="on" data-sex="male">Ø±Ø¬Ù„</button>
            <button type="button" data-sex="female">Ø§Ù…Ø±Ø£Ø©</button>
          </div>
        </div>

        <!-- Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© -->
        <div class="field center">
          <label><strong>Ø¹ÙˆØ§Ù…Ù„ Ù…Ø¤Ø«Ø±Ø©</strong></label>
          <div class="seg" id="smokeSeg">
            <button type="button" class="on" data-smoke="no">ØºÙŠØ± Ù…Ø¯Ø®Ù‘Ù†</button>
            <button type="button" data-smoke="yes">Ù…Ø¯Ø®Ù‘Ù†</button>
          </div>
          <div style="margin-top:8px" class="seg" id="chronicSeg">
            <button type="button" class="on" data-chronic="no">Ù„Ø§ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©</button>
            <button type="button" data-chronic="yes">Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©</button>
          </div>
          <div style="margin-top:8px" class="seg" id="activitySeg">
            <button type="button" class="on" data-activity="active">Ù†Ø´ÙØ· Ø¨Ø¯Ù†ÙŠÙ‹Ø§</button>
            <button type="button" data-activity="inactive">ØºÙŠØ± Ù†Ø´ÙØ·</button>
          </div>
        </div>

        <button class="btn" id="calc">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ</button>

        <!-- Ø²Ø± ØªÙ†Ø²ÙŠÙ„ PDF -->
        <div class="pdfwrap" id="pdfwrap">
          <button class="pdfbtn" id="pdfBtn">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ PDF</button>
        </div>
      </div>

      <div>
        <div id="verdict" class="badge ok" style="display:none"></div>

        <div id="counterDone" class="counter" style="display:none">
          <h4>Ù…Ø¶Ù‰ Ù…Ù† Ø¹Ù…Ø±Ùƒ</h4>
          <div class="cflex">
            <div class="cbox"><div class="num" id="cntY">0</div><div class="lbl">Ø³Ù†Ø©</div></div>
            <div class="cbox"><div class="num" id="cntM">0</div><div class="lbl">Ø´Ù‡Ø±</div></div>
            <div class="cbox"><div class="num" id="cntD">0</div><div class="lbl">ÙŠÙˆÙ…</div></div>
          </div>
        </div>

        <div id="counterRemain" class="counter alt" style="display:none">
          <h4>Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ</h4>
          <div class="cflex">
            <div class="cbox"><div class="num" id="remY">0</div><div class="lbl">Ø³Ù†Ø©</div></div>
            <div class="cbox"><div class="num" id="remM">0</div><div class="lbl">Ø´Ù‡Ø±</div></div>
            <div class="cbox"><div class="num" id="remD">0</div><div class="lbl">ÙŠÙˆÙ…</div></div>
          </div>
        </div>

        <div id="kpis" class="kpi" style="display:none">
          <div class="k"><div class="v" id="ageSolar">â€”</div><div>Ø¹ÙÙ…Ø±Ùƒ Ø§Ù„Ø¢Ù† (Ø³Ù†ÙˆØ§Øª Ù…ÙŠÙ„Ø§Ø¯ÙŠØ©)</div></div>
          <div class="k"><div class="v" id="lifeExp">â€”</div><div>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø³Ù†ÙˆØ§Øª)</div></div>
        </div>

        <div id="eqwrap" class="eqwrap">
          <div class="eqbox">
            <div class="v" id="eqVal">â€”</div>
            <div class="l" id="eqLbl">ØªØ§Ø±ÙŠØ® Ø¨Ù„ÙˆØº Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (ØªÙ‚Ø±ÙŠØ¨ Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</div>
          </div>
        </div>
      </div>
    </div>

    <div id="advice" class="deck" style="display:none"></div>
  </section>

  <!-- Ù…Ø´Ø§Ø±ÙƒØ© -->
  <div class="sharewrap">
    <div id="shareTitle" class="share-title">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØµÙØ­Ø©</div>
    <div class="sharebar">
      <a class="iconbtn" id="shareWA" title="ÙˆØ§ØªØ³Ø§Ø¨" aria-label="WhatsApp">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 0a12 12 0 00-10 18.3L1 23l4.9-1A12 12 0 1012 0zm6.5 17.2c-.3.8-1.7 1.6-2.4 1.6-.6 0-1.4.1-3.8-1-3.2-1.4-5.3-4.6-5.5-4.8-.1-.2-1.3-1.7-1.3-3.2 0-1.6.8-2.4 1.1-2.7.3-.3.7-.4 1-.4h.8c.2 0 .6 0 .9.7.3.8 1.1 2.7 1.2 2.9.1.2.2.5 0 .8-.2.3-.3.5-.6.8-.3.3-.6.6-.2 1.2.4.6 1.7 2.8 4 3.8 2.9 1.2 3 .8 3.5.8.5 0 1.8-.8 2.1-1.5.2-.7 1-1.6 1.3-1.8.2-.1.3-.2.5-.1l1 .5c.3.1.5.3.5.5-.1.4-.7 2-1 2.7z"/></svg>
      </a>
      <a class="iconbtn" id="shareTG" title="ØªÙŠÙ„ÙŠØºØ±Ø§Ù…" aria-label="Telegram">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M9 18.2l-.3 4.1c.4 0 .6-.2.8-.4l2-1.8 4.1 3c.7.4 1.3.2 1.5-.7L22 6.2c.2-1.1-.4-1.5-1.1-1.2L2.3 11.1c-1.1.4-1 1.3 0 1.6l4.1 1.2 9.4-5.9c.4-.3.9-.1.5.2L9 18.2z"/></svg>
      </a>
      <a class="iconbtn" id="shareX" title="X" aria-label="X">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 2h4.7l5 6.8L18.7 2H22l-7.8 9.1L22 22h-4.8l-5.4-7.2L6 22H2.1l8.3-9.8L3 2z"/></svg>
      </a>
      <a class="iconbtn" id="shareFB" title="Facebook" aria-label="Facebook">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12a10 10 0 10-11.6 9.9v-7H7.7V12h2.7V9.8c0-2.7 1.6-4.2 4-4.2 1.2 0 2.5.2 2.5.2v2.7h-1.4c-1.4 0-1.9.9-1.9 1.8V12h3.2l-.5 2.9h-2.7v7A10 10 0 0022 12z"/></svg>
      </a>
      <button class="iconbtn" id="copyLink" title="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·" aria-label="Copy Link">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H8C6.3 1 5 2.3 5 4v12c0 1.7 1.3 3 3 3h8c1.7 0 3-1.3 3-3V4c0-1.7-1.3-3-3-3zm1 15c0 .6-.4 1-1 1H8c-.6 0-1-.4-1-1V4c0-.6.4-1 1-1h8c.6 0 1 .4 1 1v12zM7 20c0 .6.4 1 1 1h8v2H8c-1.7 0-3-1.3-3-3v-2h2v2z"/></svg>
      </button>
    </div>
  </div>

  <footer id="footer">
    <div style="margin-top:8px; line-height:1.7">
      <strong>Ø§Ù„Ù…ØµØ§Ø¯Ø±:</strong>
      Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¯ÙˆÙ„ÙŠ (LE Ø°ÙƒÙˆØ±/Ø¥Ù†Ø§Ø«) â€” Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø£ØµÙ„ÙŠ: UN WPP. ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ¯Ø®ÙŠÙ† ~10 Ø³Ù†ÙˆØ§Øª (ØªÙ‚Ø±ÙŠØ¨ÙŠ). Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ ØªÙ‚Ø¯ÙŠØ± ØªØ¹Ù„ÙŠÙ…ÙŠ.
    </div>
    <div style="margin-top:10px">
      <a id="devLink" class="ghost-link" href="https://api.whatsapp.com/send/?phone=97333375858&text&type=phone_number&app_absent=0&wame_ctl=1" target="_blank" rel="noopener">
        Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ±: ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³
      </a>
    </div>
  </footer>
</main>

<!-- Ø¥Ø´Ø¹Ø§Ø± -->
<div id="notice" class="notice" style="display:none">
  <div class="dot"></div>
  <div class="text">â€”</div>
  <button class="close" title="Ø¥ØºÙ„Ø§Ù‚" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ã—</button>
</div>

<!-- Ù…ÙƒØªØ¨Ø§Øª PDF (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

<script>
/* ==== Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ø­Ø³Ø§Ø¨ ==== */
const SOLAR_YEAR = 365.2425;
const PENALTY_SMOKER = 10.0;
const PENALTY_CHRONIC = 3.0;
const ACTIVITY_ACTIVE_BONUS = 2.0;
const ACTIVITY_INACTIVE_PENALTY = 1.0;

/* ==== Ø¹Ù†Ø§ØµØ± ==== */
const dEl=document.getElementById('d'), mEl=document.getElementById('m'), yEl=document.getElementById('y');
const countrySelect=document.getElementById('countrySelect');
const sexSeg=document.getElementById('sexSeg'), smokeSeg=document.getElementById('smokeSeg'), chronicSeg=document.getElementById('chronicSeg'), activitySeg=document.getElementById('activitySeg');
const verdict=document.getElementById('verdict'), kpis=document.getElementById('kpis');
const ageSolarEl=document.getElementById('ageSolar'), lifeExpEl=document.getElementById('lifeExp');
const counterDone=document.getElementById('counterDone'), cntY=document.getElementById('cntY'), cntM=document.getElementById('cntM'), cntD=document.getElementById('cntD');
const counterRemain=document.getElementById('counterRemain'), remY=document.getElementById('remY'), remM=document.getElementById('remM'), remD=document.getElementById('remD');
const eqWrap=document.getElementById('eqwrap'), eqVal=document.getElementById('eqVal');
const adviceDeck=document.getElementById('advice');
const pdfwrap=document.getElementById('pdfwrap'), pdfBtn=document.getElementById('pdfBtn');

const notice=document.getElementById('notice'), noticeText=notice.querySelector('.text'); notice.querySelector('.close').onclick=()=>{ notice.classList.remove('show'); setTimeout(()=>notice.style.display='none',250); };
let selectedSex="male", isSmoker="no", hasChronic="no", activity="active";

/* ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
[sexSeg, smokeSeg, chronicSeg, activitySeg].forEach(seg=>{
  seg.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click',()=>{ seg.querySelectorAll('button').forEach(x=>x.classList.remove('on')); b.classList.add('on'); const k=[...'data-'.split()].length; });
  });
});
sexSeg.onclick=e=>{const b=e.target.closest('button'); if(!b)return; selectedSex=b.dataset.sex;}
smokeSeg.onclick=e=>{const b=e.target.closest('button'); if(!b)return; isSmoker=b.dataset.smoke;}
chronicSeg.onclick=e=>{const b=e.target.closest('button'); if(!b)return; hasChronic=b.dataset.chronic;}
activitySeg.onclick=e=>{const b=e.target.closest('button'); if(!b)return; activity=b.dataset.activity;}

/* Ø¥Ø´Ø¹Ø§Ø± Ø£Ù†ÙŠÙ‚ */
let nTimer=null; function notify(msg,{type='info',timeout=3500}={}){ notice.style.display='flex'; notice.classList.toggle('error', type==='error'); noticeText.innerHTML=msg; requestAnimationFrame(()=>notice.classList.add('show')); clearTimeout(nTimer); nTimer=setTimeout(()=>{ notice.classList.remove('show'); setTimeout(()=>notice.style.display='none',250); }, timeout); }

/* Ø£Ø¯ÙˆØ§Øª ØªØ§Ø±ÙŠØ® */
function daysInMonthUTC(y,m){ return new Date(Date.UTC(y, m, 0)).getUTCDate(); }
function fmtDate(d){ return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`; }
function diffYMD(fromUTC, toUTCDate){
  let y = toUTCDate.getUTCFullYear() - fromUTC.getUTCFullYear();
  let m = toUTCDate.getUTCMonth() + 1 - (fromUTC.getUTCMonth() + 1);
  let d = toUTCDate.getUTCDate() - fromUTC.getUTCDate();
  if(d < 0){ const prevMonth = new Date(Date.UTC(toUTCDate.getUTCFullYear(), toUTCDate.getUTCMonth(), 0)); d += prevMonth.getUTCDate(); m -= 1; }
  if(m < 0){ m += 12; y -= 1; }
  if(y < 0){ y=0; m=0; d=0; }
  return {y,m,d};
}
function validateFullDate(d,m,y){
  if(!(y>=1900 && y<=2100)) { notify('Ø£Ø¯Ø®Ù„ Ø³Ù†Ø© ØµØ­ÙŠØ­Ø© Ø¨ÙŠÙ† 1900 Ùˆ 2100.', {type:'error'}); return false; }
  if(!(m>=1 && m<=12))      { notify('Ø£Ø¯Ø®Ù„ Ø´Ù‡Ø±Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø¨ÙŠÙ† 1 Ùˆ 12.',      {type:'error'}); return false; }
  if(!(d>=1 && d<=31))      { notify('Ø£Ø¯Ø®Ù„ ÙŠÙˆÙ…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø¨ÙŠÙ† 1 Ùˆ 31.',       {type:'error'}); return false; }
  const dim = daysInMonthUTC(y, m);
  if(d > dim){ notify(`Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙŠØ­ØªÙˆÙŠ ${dim} ÙŠÙˆÙ…Ù‹Ø§ ÙÙ‚Ø·. ØµØ­Ù‘Ø­ Ø§Ù„ÙŠÙˆÙ….`, {type:'error'}); return false; }
  const dob=new Date(Date.UTC(y, m-1, d));
  const today=new Date();
  if(dob > today){ notify('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.', {type:'error'}); return false; }
  return true;
}
const SOLAR_MS=24*60*60*1000*SOLAR_YEAR;
function calcAgeYears(dobUTC, todayUTC){ return (todayUTC-dobUTC)/SOLAR_MS; }
function addYearsExact(baseUTC, years){ const days=Math.round(years*SOLAR_YEAR); return new Date(baseUTC.getTime()+days*24*60*60*1000); }

/* Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¯ÙˆÙ„ÙŠ */
async function fetchLE(iso3){
  const base=`https://api.worldbank.org/v2/country/${iso3}/indicator/`;
  async function latest(ind){
    const res=await fetch(`${base}${ind}?format=json&per_page=100`);
    if(!res.ok) throw new Error('WB fetch failed');
    const js=await res.json(); const series=js?.[1]||[];
    for(const row of series){ if(row.value!=null) return {val:Number(row.value), year:row.date}; }
    return {val:null, year:null};
  }
  const [fe,ma]=await Promise.all([latest('SP.DYN.LE00.FE.IN'), latest('SP.DYN.LE00.MA.IN')]);
  return {female:fe, male:ma};
}

/* Ù†ØµØ§Ø¦Ø­ */
function buildAdvice(){
  const mk=(t,html)=>{ const e=document.createElement('div'); e.className='card'; e.innerHTML=`<h3>${t}</h3>${html}`; return e; };
  adviceDeck.innerHTML='';
  adviceDeck.append(
    mk('ÙØ­ÙˆØµØ§Øª Ø¹Ø§Ù…Ø© Ø¯ÙˆØ±ÙŠØ©','<ul><li>Ø¶ØºØ· Ø§Ù„Ø¯Ù…ØŒ Ø§Ù„Ø³ÙƒØ±ØŒ Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¯Ù…ØŒ Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù….</li><li>Ø£Ø³Ù†Ø§Ù†/Ù†Ø¸Ø±/Ø³Ù…Ø¹ Ø³Ù†ÙˆÙŠÙ‹Ø§ ÙˆØ§Ù„ØªØ·Ø¹ÙŠÙ…Ø§Øª.</li><li>Ù†Ø´Ø§Ø· Ø¨Ø¯Ù†ÙŠ â‰¥ 150 Ø¯Ù‚ÙŠÙ‚Ø©/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆÙ†ÙˆÙ… ÙƒØ§ÙÙ.</li></ul>'),
    mk('Ù„Ù„Ø±Ø¬Ø§Ù„','<ul><li>Ø³Ø±Ø·Ø§Ù† Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ†: Ù…Ù† 45â€“50.</li><li>Ø§Ù„Ø¨Ø±ÙˆØ³ØªØ§ØªØ§: Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø®Ø·ÙˆØ±Ø©.</li><li>Ø§Ù„Ù‚Ù„Ø¨: ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆÙØ­ÙˆØµ Ù„Ø§Ø²Ù…Ø©.</li></ul>'),
    mk('Ù„Ù„Ù†Ø³Ø§Ø¡','<ul><li>Ø³Ø±Ø·Ø§Ù† Ø§Ù„Ø«Ø¯ÙŠ: ØªØµÙˆÙŠØ± Ø¯ÙˆØ±ÙŠ Ù…Ù† 40â€“50.</li><li>Ø¹Ù†Ù‚ Ø§Ù„Ø±Ø­Ù…: Pap/HPV Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©.</li><li>Ù‡Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø¸Ø§Ù…: Ø¨Ø¹Ø¯ 50â€“65 Ø£Ùˆ Ù…Ø¹ Ø¹ÙˆØ§Ù…Ù„ Ø®Ø·ÙˆØ±Ø©.</li></ul>'),
    mk('Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©','<ul><li>Ø§Ù„Ø¥Ù‚Ù„Ø§Ø¹ Ø¹Ù† Ø§Ù„ØªØ¯Ø®ÙŠÙ†.</li><li>ØºØ°Ø§Ø¡ Ù…ØªÙˆØ§Ø²Ù† ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ø­/Ø§Ù„Ø³ÙƒØ±/Ø§Ù„Ø¯Ù‡ÙˆÙ† Ø§Ù„Ù…Ø´Ø¨Ø¹Ø©.</li><li>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙˆØªØ±ØŒ Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©ØŒ ÙƒØ´Ù Ù…Ø¨ÙƒØ± Ø¹Ù†Ø¯ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶.</li></ul>')
  );
  adviceDeck.style.display='grid';
}

/* Ø§Ù„Ø­Ø³Ø§Ø¨ + Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± PDF */
document.getElementById('calc').addEventListener('click', async ()=>{
  const d=parseInt(dEl.value,10), m=parseInt(mEl.value,10), y=parseInt(yEl.value,10);
  if(!validateFullDate(d,m,y)) return;

  let data; const iso3=countrySelect.value;
  try{ data=await fetchLE(iso3); }catch(e){ notify('ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¯ÙˆÙ„ÙŠ. ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„.', {type:'error'}); return; }
  let baseLE = (selectedSex==='male') ? data.male.val : data.female.val;
  let baseYear = (selectedSex==='male') ? data.male.year : data.female.year;
  if(!baseLE){ baseLE=data.male.val||data.female.val; baseYear=data.male.year||data.female.year; }
  if(!baseLE){ notify('Ù„Ù… Ù†Ø¬Ø¯ Ù‚ÙŠÙ…Ø© Ø¹Ù…Ø± Ù…ØªÙˆÙ‚Ø¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù„Ø¯.', {type:'error'}); return; }

  const dobUTC=new Date(Date.UTC(y, m-1, d));
  const today=new Date(); const todayUTC=new Date(Date.UTC(today.getFullYear(),today.getMonth(),today.getDate()));
  const ageYears=calcAgeYears(dobUTC,todayUTC);

  let leAdj=baseLE;
  if(isSmoker==='yes') leAdj -= PENALTY_SMOKER;
  if(hasChronic==='yes') leAdj -= PENALTY_CHRONIC;
  if(activity==='active') leAdj += ACTIVITY_ACTIVE_BONUS;
  if(activity==='inactive') leAdj -= ACTIVITY_INACTIVE_PENALTY;
  if(leAdj<1) leAdj=1;

  const targetUTC=addYearsExact(dobUTC, leAdj);
  const remainingMs=targetUTC - todayUTC;

  verdict.style.display='inline-block';
  verdict.textContent=(remainingMs<=0) ? `â„¹ï¸ Ø¨Ù„ØºØª/ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (${baseYear}).` : `ğŸ” ØªÙ‚Ø¯ÙŠØ± ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ ÙˆÙÙ‚ (${baseYear}).`;

  kpis.style.display='grid';
  ageSolarEl.textContent=`${ageYears.toFixed(1)} Ø³Ù†Ø©`;
  lifeExpEl.textContent=`${leAdj.toFixed(1)} Ø³Ù†Ø©`;

  const elapsedDiff=diffYMD(dobUTC,todayUTC);
  cntY.textContent=elapsedDiff.y; cntM.textContent=elapsedDiff.m; cntD.textContent=elapsedDiff.d;
  counterDone.style.display='block';

  if(remainingMs>0){
    const remainDiff=diffYMD(todayUTC,targetUTC);
    remY.textContent=remainDiff.y; remM.textContent=remainDiff.m; remD.textContent=remainDiff.d;
    counterRemain.style.display='block';
  }else{
    counterRemain.style.display='none';
  }

  eqWrap.style.display='block';
  eqVal.textContent=fmtDate(targetUTC);

  buildAdvice();

  // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± PDF Ø¨Ø¹Ø¯ ØªÙˆÙØ± Ù†ØªØ§Ø¦Ø¬
  pdfwrap.style.display='block';

  // Ø®Ø²Ù‘Ù† Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ PDF
  window.__lastResult = {
    dob: fmtDate(dobUTC), country: countrySelect.options[countrySelect.selectedIndex].text,
    sex: (selectedSex==='male'?'Ø±Ø¬Ù„':'Ø§Ù…Ø±Ø£Ø©'),
    smoker: (isSmoker==='yes'?'Ù…Ø¯Ø®Ù‘Ù†':'ØºÙŠØ± Ù…Ø¯Ø®Ù‘Ù†'),
    chronic: (hasChronic==='yes'?'Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©':'Ù„Ø§'),
    activity: (activity==='active'?'Ù†Ø´ÙØ· Ø¨Ø¯Ù†ÙŠÙ‹Ø§':'ØºÙŠØ± Ù†Ø´ÙØ·'),
    baseLE: baseLE?.toFixed(1), baseYear,
    adjLE: leAdj.toFixed(1),
    ageNow: ageYears.toFixed(1),
    spent: `${elapsedDiff.y} Ø³Ù†Ø©ØŒ ${elapsedDiff.m} Ø´Ù‡Ø±ØŒ ${elapsedDiff.d} ÙŠÙˆÙ…`,
    remain: (remainingMs>0)?`${remY.textContent} Ø³Ù†Ø©ØŒ ${remM.textContent} Ø´Ù‡Ø±ØŒ ${remD.textContent} ÙŠÙˆÙ…`:'â€”',
    targetDate: fmtDate(targetUTC)
  };
});

/* Ù…Ø´Ø§Ø±ÙƒØ© */
const shareTitle=document.getElementById('shareTitle');
['shareWA','shareTG','shareX','shareFB','copyLink'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el) return;
});
shareTitle.addEventListener('click', async ()=>{
  const url=location.href;
  if(navigator.share){ try{ await navigator.share({title:document.title,text:'Ø¬Ø±Ù‘Ø¨ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©:',url}); }catch(_){} }
  else{ try{ await navigator.clipboard.writeText(url); notify('ğŸ”— ØªÙ…Ù‘ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©.'); }catch(_){ notify('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.',{type:'error'}); } }
});
document.getElementById('shareWA').onclick=(e)=>{e.preventDefault(); window.open(`https://wa.me/?text=${encodeURIComponent(location.href)}`,'_blank','noopener');}
document.getElementById('shareTG').onclick=(e)=>{e.preventDefault(); window.open(`https://t.me/share/url?url=${encodeURIComponent(location.href)}`,'_blank','noopener');}
document.getElementById('shareX').onclick=(e)=>{e.preventDefault(); window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(location.href)}`,'_blank','noopener');}
document.getElementById('shareFB').onclick=(e)=>{e.preventDefault(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}`,'_blank','noopener');}
document.getElementById('copyLink').onclick=async()=>{ try{ await navigator.clipboard.writeText(location.href); notify('ğŸ”— ØªÙ…Ù‘ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©.'); }catch(_){ notify('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.',{type:'error'});} };

/* ØªÙ†Ø²ÙŠÙ„ PDF â€” Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© RTL ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ PDF A4 */
document.getElementById('pdfBtn').addEventListener('click', async ()=>{
  const R = window.__lastResult;
  if(!R){ notify('Ø§Ø­Ø³Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø­Ø§ÙˆÙÙ„ ØªÙ†Ø²ÙŠÙ„ PDF.', {type:'error'}); return; }

  // Ø¹Ù†ØµØ± HTML Ù…Ø®ÙÙŠ Ù„Ø¨Ù†Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø£Ù†ÙŠÙ‚
  const box=document.createElement('div');
  box.setAttribute('dir','rtl');
  box.style.width='780px'; // Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù€ A4 Ø¨Ù†Ù‚Ø§Ø¡ Ø¬ÙŠØ¯
  box.style.background='#fff';
  box.style.border='1px solid #e5e7eb';
  box.style.borderRadius='16px';
  box.style.padding='20px';
  box.style.fontFamily='"Cairo",sans-serif';
  box.style.color='#111827';
  box.innerHTML=`
    <div style="text-align:center; margin-bottom:10px">
      <div style="font-family:'Amiri',serif; font-size:28px; color:${getComputedStyle(document.documentElement).getPropertyValue('--gold')}">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ â€” Ù…Ù„Ø®Ù‘Øµ Ø´Ø®ØµÙŠ</div>
      <div style="font-size:12px; color:#6b7280">${new Date().toLocaleString('ar')}</div>
    </div>

    <table style="width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid #eee">
      <thead>
        <tr style="background:linear-gradient(90deg, #fff7e6, #fff)">
          <th style="padding:10px 12px; text-align:right; border-bottom:1px solid #eee">Ø§Ù„Ø¨Ù†Ø¯</th>
          <th style="padding:10px 12px; text-align:right; border-bottom:1px solid #eee">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
        </tr>
      </thead>
      <tbody>
        ${row('Ø§Ù„Ø¯ÙˆÙ„Ø©', R.country)}
        ${row('Ø§Ù„Ù†ÙˆØ¹', R.sex)}
        ${row('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯', R.dob)}
        ${row('Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¢Ù† (Ø³Ù†ÙˆØ§Øª)', R.ageNow)}
        ${row('Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ ('+R.baseYear+')', R.baseLE)}
        ${row('Ø§Ù„ØªØ¯Ø®ÙŠÙ†', R.smoker)}
        ${row('Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©', R.chronic)}
        ${row('Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ', R.activity)}
        ${row('Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', R.adjLE)}
        ${row('Ù…Ø¶Ù‰ Ù…Ù† Ø¹Ù…Ø±Ùƒ', R.spent)}
        ${row('Ø§Ù„Ù…ØªØ¨Ù‚Ù‘ÙŠ Ù…Ù† Ø¹Ù…Ø±Ùƒ', R.remain)}
        ${row('ØªØ§Ø±ÙŠØ® Ø¨Ù„ÙˆØº Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹', R.targetDate)}
      </tbody>
    </table>

    <div style="margin-top:12px; font-size:12px; color:#6b7280; line-height:1.7">
      <strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø¯ÙˆÙ„ÙŠ (LE Ø°ÙƒÙˆØ±/Ø¥Ù†Ø§Ø«) â€” UN WPP. Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª (Ø§Ù„ØªØ¯Ø®ÙŠÙ†/Ø§Ù„Ù†Ø´Ø§Ø·/Ø§Ù„Ø£Ù…Ø±Ø§Ø¶) ØªÙ‚Ø¯ÙŠØ±Ø§Øª ØªØ«Ù‚ÙŠÙÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©.
    </div>
  `;
  function row(k,v){
    return `<tr>
      <td style="padding:10px 12px; border-bottom:1px solid #f3f4f6"><strong>${k}</strong></td>
      <td style="padding:10px 12px; border-bottom:1px solid #f3f4f6">${v}</td>
    </tr>`;
  }

  document.body.appendChild(box);
  // Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·/Ø§Ù„ØªØ®Ø·ÙŠØ·
  await new Promise(r=>setTimeout(r, 120));

  const canvas = await html2canvas(box, {scale:2, useCORS:true});
  document.body.removeChild(box);

  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({orientation:'p', unit:'pt', format:'a4'});

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  // Ù‚ÙŠØ§Ø³ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ù‡ÙˆØ§Ù…Ø´
  const margin = 28;
  const imgW = pageW - margin*2;
  const imgH = canvas.height * (imgW / canvas.width);

  let y = margin;
  if(imgH <= pageH - margin*2){
    pdf.addImage(imgData, 'PNG', margin, y, imgW, imgH);
  }else{
    // ØªÙ‚Ø·ÙŠØ¹ Ø¹Ù…ÙˆØ¯ÙŠ Ø¥Ø°Ø§ Ø·Ø§Ù„
    let sH = pageH - margin*2;
    let ratio = canvas.width / imgW;
    let slice = sH * ratio; // Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ Ù„ÙÙ‚ØµÙ‘ Ø§Ù„ØµÙˆØ±Ø©
    let pos = 0;
    while(pos < canvas.height){
      const sliceCanvas = document.createElement('canvas');
      sliceCanvas.width = canvas.width;
      sliceCanvas.height = Math.min(slice, canvas.height - pos);
      const ctx = sliceCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, pos, canvas.width, sliceCanvas.height, 0, 0, sliceCanvas.width, sliceCanvas.height);
      const sliceData = sliceCanvas.toDataURL('image/png');
      if(pos>0) pdf.addPage();
      pdf.addImage(sliceData, 'PNG', margin, margin, imgW, (sliceCanvas.height / ratio));
      pos += slice;
    }
  }

  pdf.save('Ù†ØªÙŠØ¬ØªÙƒ.pdf');
});

/* Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© */
document.getElementById('shareWA').addEventListener('click', e=>{e.preventDefault(); window.open('https://wa.me/?text='+encodeURIComponent(location.href),'_blank','noopener');});
document.getElementById('shareTG').addEventListener('click', e=>{e.preventDefault(); window.open('https://t.me/share/url?url='+encodeURIComponent(location.href),'_blank','noopener');});
document.getElementById('shareX').addEventListener('click', e=>{e.preventDefault(); window.open('https://twitter.com/intent/tweet?url='+encodeURIComponent(location.href),'_blank','noopener');});
document.getElementById('shareFB').addEventListener('click', e=>{e.preventDefault(); window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),'_blank','noopener');});
document.getElementById('copyLink').addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(location.href); notify('ğŸ”— ØªÙ…Ù‘ Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©.'); }catch(_){ notify('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·.',{type:'error'});} });

/* Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ØµØºÙŠØ±Ø© */
document.getElementById('devLink').addEventListener('click', function(){ setTimeout(()=>{ if(!document.hasFocus()) return; location.href=this.href; }, 100); });
</script>
</body>
</html>
