document.addEventListener('DOMContentLoaded', () => {
  /* ========= أدوات مساعدة ========= */
  const $ = s => document.querySelector(s);
  const fmt = (n, d = 2) => (n == null || Number.isNaN(n)) ? "—" : Number(n).toLocaleString('en-US', { maximumFractionDigits: d });
  const now = () => { const d = new Date(), p = n => String(n).padStart(2, "0"); $("#lastUpdated").textContent = `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }

  // جلب مرن بمحاولات متعددة
  async function fetchCascade(urls, timeout = 8000) {
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeout);
    let lastErr;
    for (const u of urls) {
      try {
        const r = await fetch(u, { signal: ctrl.signal, headers: { 'Cache-Control': 'no-cache' } });
        if (!r.ok) throw new Error(`status ${r.status}`);
        const data = await r.json();
        clearTimeout(timer);
        return data;
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error('All fetch attempts failed');
  }

  /* ========= المصادر الجديدة ========= */
  // واجهة برمجة تطبيقات مجانية للأسعار (بديل لـ Stooq)
  const DATA_API_URL = "https://api.metals.live/v1/spot";

  /* ========= التسميات العربية ========= */
  function arabicName(s) {
    const m = { "EURUSD": "يورو/دولار", "GBPUSD": "جنيه إسترليني/دولار", "XAUUSD": "ذهب/دولار", "XAGUSD": "فضة/دولار" };
    return m[s] || s;
  }

  /* ========= الحالة ========= */
  let ALL_DATA = [];

  /* ========= جلب البيانات الموحد ========= */
  async function loadData() {
    try {
      const data = await fetchCascade([DATA_API_URL]);
      const processedData = [];
      
      // معالجة البيانات المستلمة
      if (data && Array.isArray(data)) {
        const gold = data.find(m => m.metal === 'gold');
        const silver = data.find(m => m.metal === 'silver');
        const eur = data.find(m => m.metal === 'eur');
        const gbp = data.find(m => m.metal === 'gbp');

        if (gold) {
          processedData.push({ symbol: 'XAUUSD', last: gold.price, change: gold.changePercentage, vol: null });
        }
        if (silver) {
          processedData.push({ symbol: 'XAGUSD', last: silver.price, change: silver.changePercentage, vol: null });
        }
        if (eur) {
          processedData.push({ symbol: 'EURUSD', last: eur.price, change: eur.changePercentage, vol: null });
        }
        if (gbp) {
          processedData.push({ symbol: 'GBPUSD', last: gbp.price, change: gbp.changePercentage, vol: null });
        }
      }
      
      ALL_DATA = processedData;

    } catch (error) {
      console.error("Failed to load data:", error);
      ALL_DATA = []; // إفراغ البيانات عند الفشل لمنع عرض بيانات قديمة
    }
  }


  /* ========= اشتقاقات/عرض ========= */
  function buildForecastRows(list) {
    return list.map(p => {
      const changePercent = (p.change ?? 0);
      // تعديل بسيط لمنطق الإشارة ليتناسب مع التغير المئوي المباشر
      const sig = changePercent > 0.3 ? "bull" : changePercent < -0.3 ? "bear" : "neutral";
      return { symbol: p.symbol, f1h: p.last * (1 + (changePercent / 100) * 0.6), f1d: p.last * (1 + (changePercent / 100) * 1.2), sig };
    });
  }
  const NS = 'http://www.w3.org/2000/svg';
  const make = (d, fill) => { const s = document.createElementNS(NS, 'svg'); s.setAttribute('viewBox', '0 0 24 24'); const p = document.createElementNS(NS, 'path'); p.setAttribute('d', d); p.setAttribute('fill', fill); s.appendChild(p); return s };
  const up = () => make('M12 4l6 6h-4v10h-4V10H6z', '#0a7a2f');
  const dn = () => make('M12 20l-6-6h4V4h4v10h4z', '#b11a1a');
  const fl = () => make('M4 11h16v2H4z', '#555');


  function renderPrices(list) {
    const tb = $("#pricesTbody"); tb.innerHTML = "";
    if (!list.length) { tb.innerHTML = '<tr><td colspan="4" class="empty">لا توجد بيانات متاحة حاليًا</td></tr>'; return; }
    for (const p of list) {
      const tr = document.createElement("tr");
      const digits = p.symbol.includes('USD') && !p.symbol.startsWith('X') ? 4 : 2;
      tr.innerHTML = `<td class="sym"><b>${arabicName(p.symbol)}</b></td>
        <td class="num">${fmt(p.last, digits)}</td>
        <td class="num" style="font-weight:800;color:${(p.change ?? 0) >= 0 ? 'var(--pos)' : 'var(--neg)'}">${(p.change ?? 0) >= 0 ? '↑' : '↓'} ${fmt(Math.abs(p.change ?? 0), 2)}%</td>
        <td class="num">${fmt(p.vol ?? 0, 0)}</td>`;
      tb.appendChild(tr);
    }
  }

  function renderForecast(list) {
    const tb = $("#forecastTbody"); tb.innerHTML = "";
    if (!list.length) { tb.innerHTML = '<tr><td colspan="4" class="empty">لا توجد بيانات متاحة حاليًا</td></tr>'; return; }
    for (const f of buildForecastRows(list)) {
      let cls, icon;
      if (f.sig === 'bull') { cls = 'sig-bull'; icon = up() }
      else if (f.sig === 'bear') { cls = 'sig-bear'; icon = dn() }
      else { cls = 'sig-neutral'; icon = fl() }
      const sigBox = document.createElement('span'); sigBox.className = `sigbox ${cls}`; sigBox.appendChild(icon);
      const tr = document.createElement("tr");
      const digits = f.symbol.includes('USD') && !f.symbol.startsWith('X') ? 4 : 2;
      tr.innerHTML = `<td class="sym"><b>${arabicName(f.symbol)}</b></td>
                    <td class="num">${fmt(f.f1h, digits)}</td>
                    <td class="num">${fmt(f.f1d, digits)}</td>`;
      const td = document.createElement('td'); td.className = 'sigcell'; td.appendChild(sigBox); tr.appendChild(td);
      tb.appendChild(tr);
    }
  }

  function buildRecommendations(list) { const buy = [], sell = []; for (const p of list) { if ((p.change ?? 0) >= 1.5) buy.push(p); if ((p.change ?? 0) <= -1.5) sell.push(p) } return { buy, sell } }
  function renderRecommendations(list) {
    const { buy, sell } = buildRecommendations(list), b = $("#buyList"), s = $("#sellList"), cb = $("#card-buy"), cs = $("#card-sell");
    b.innerHTML = ""; s.innerHTML = "";
    if (!buy.length) cb.style.display = "none"; else { cb.style.display = "block"; for (const r of buy) { const d = document.createElement("div"); d.className = "alert"; d.innerHTML = `<span><b>${arabicName(r.symbol)}</b> — إشارة شراء</span>`; const sig = document.createElement('span'); sig.className = 'sigbox sig-bull'; sig.appendChild(up()); d.appendChild(sig); b.appendChild(d) } }
    if (!sell.length) cs.style.display = "none"; else { cs.style.display = "block"; for (const r of sell) { const d = document.createElement("div"); d.className = "alert"; d.innerHTML = `<span><b>${arabicName(r.symbol)}</b> — إشارة بيع</span>`; const sig = document.createElement('span'); sig.className = 'sigbox sig-bear'; sig.appendChild(dn()); d.appendChild(sig); s.appendChild(d) } }
  }

  function renderAlerts(list) {
    const arr = list.filter(p => p.change != null && Math.abs(p.change) >= 3).map(p => ({ symbol: p.symbol, change: p.change, dir: p.change >= 0 ? 'bull' : 'bear' })),
      a = $("#alertsList"); a.innerHTML = "";
    if (!arr.length) { a.innerHTML = '<div class="empty">لا توجد تنبيهات حاليًا</div>'; return }
    for (const x of arr) { const row = document.createElement("div"); row.className = "alert"; const left = document.createElement('span'); left.innerHTML = `<b>${arabicName(x.symbol)}</b> — ${x.change >= 0 ? 'ارتفع' : 'انخفض'} ${fmt(Math.abs(x.change), 2)}%`; const sig = document.createElement('span'); sig.className = `sigbox ${x.dir === 'bull' ? 'sig-bull' : 'sig-bear'}`; sig.appendChild(x.dir === 'bull' ? up() : dn()); row.appendChild(left); row.appendChild(sig); a.appendChild(row) }
  }

  function renderAll() {
    renderPrices(ALL_DATA); renderForecast(ALL_DATA); renderRecommendations(ALL_DATA); renderAlerts(ALL_DATA); now();
  }

  /* ========= نصيحة واحدة ========= */
  const TIPS = ["ضع خطة مكتوبة للدخول والخروج وإدارة المخاطر قبل فتح الصفقة.", "لا تخاطر بأكثر من 1–2% من رأس المال في صفقة واحدة.", "استخدم أوامر وقف الخسارة دائمًا واحترمها.", "جمّد عواطفك: لا تدع الخوف أو الطمع يقودان قرارك.", "التزم بإستراتيجية مجرَّبة ولا تغيّرها بعد كل صفقة.", "قيّم الصفقات على سلسلة نتائج، لا على صفقة منفردة.", "تداول مع الاتجاه العام بدلًا من مصارعة السوق.", "لا تُطارد الحركة بعد فواتها؛ انتظر إعادة اختبار منطقية.", "نوّع محفظتك ولا تركّز كل المخاطر في أصل واحد.", "احسب العائد إلى المخاطرة قبل الدخول (مثلاً 1:2 على الأقل).", "تجنّب الإفراط في التداول؛ الجودة أهم من الكثرة.", "تاجر بأموال يمكنك تحمل خسارتها دون ضغط نفسي.", "استخدم أحجام صفقة ثابتة ومنضبطة.", "دوّن أسباب الدخول والخروج وتعلّم من المراجعة الدورية.", "لا تتداول وقت الأخبار عالية التقلّب دون خطة واضحة.", "احذر من مضاعفة الحجم لتعويض الخسائر.", "راقب السيولة والسبريد قبل التنفيذ.", "اختبر الاستراتيجية تاريخيًا وعلى حساب تجريبي أولًا.", "لا تدع صفقة رابحة تتحول إلى خاسرة—حرّك الوقف بحكمة.", "احترم مستويات الدعم والمقاومة على الأطر الزمنية الأكبر.", "اتبع إشارة واحدة واضحة بدل تكديس مؤشرات كثيرة.", "تذكّر أن عدم الدخول قرار تداول أيضًا.", "اعرف ما تتداول: العوامل المؤثرة والمخاطر الخاصة بالأصل.", "اضبط توقيتك مع جلسات السوق النشطة.", "لا تُهمل التكاليف: العمولات والانزلاق تؤثر على الأداء.", "تقبّل الخسارة الصغيرة سريعًا لتجنب الخسارة الكبيرة.", "لا تتداول بدافع الملل؛ انتظر فرصًا ذات ميزة واضحة.", "راجع الخطة عند تغيّر هيكل السوق، لا بعد كل تذبذب.", "تدرّج في زيادة الحجم بعد ثبات الأداء لا بعد صفقة واحدة.", "احمِ رأس المال أولًا—الفرص لا تنتهي."];
  $("#tipOfTheDay").textContent = TIPS[Math.floor(Math.random() * TIPS.length)];

  // روابط
  $("#openSite").addEventListener('click', e => { e.preventDefault(); const v = $("#siteSelect").value; if (v) window.open(v, '_blank', 'noopener') });
  $("#devCredit").addEventListener('click', () => window.open("https://wa.me/97333375858", '_blank', 'noopener'));

  /* ========= الأخبار العربية (بدون تغيير) ========= */
  async function loadNews() {
    const NEWS_RSS = ["https://www.cnbcarabia.com/rss/latest", "https://www.asharqbusiness.com/ar/rss", "https://www.mubasher.info/rss/news/all", "https://www.alarabiya.net/tools/rss?cat=aswaq", "https://www.argaam.com/rss/rss.xml", "https://www.alborsanews.com/feed", "https://www.skynewsarabia.com/rss/business"];
    const fetchProxy = url => fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`).then(r => r.text());
    const titles = []; const seen = new Set(); const RE = /\b(بورصة|تداول|سوق(?:\s*الأسهم)?|الأسهم|أسهم|مؤشر|أرباح|سهم|جلسة|إغلاق|توزيعات)\b/i;
    for (const u of NEWS_RSS) { try { const txt = await fetchProxy(u); const doc = new DOMParser().parseFromString(txt, "text/xml"); if (doc.querySelector("parsererror")) continue; const arr = [...doc.querySelectorAll("item>title,entry>title")].map(n => (n.textContent || "").trim()); for (const t of arr) { if (RE.test(t) && !seen.has(t)) { seen.add(t); titles.push(t) } } } catch { } }
    const bar = $("#newsbar"), track = $("#newsScroller");
    if (!titles.length) { bar.style.display = "none"; track.innerHTML = ""; return; }
    bar.style.display = "block"; track.innerHTML = "";
    for (const t of titles.concat(titles)) { const d = document.createElement("div"); d.className = "news-item"; d.textContent = t; track.appendChild(d); }
  }

  /* ========= تشغيل ========= */
  (async function init() {
    await loadData();
    renderAll();
    loadNews(); 
    
    setInterval(async () => {
      await loadData();
      renderAll();
    }, 15000); // تحديث كل 15 ثانية

    setInterval(loadNews, 120000); // تحديث الأخبار كل دقيقتين
  })();
});
