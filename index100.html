<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>الابراج والاستبصار – قراءة الطالع العميقة</title>
<meta name="description" content="قراءات فلكية تنبؤية موجزة" />
<meta name="robots" content="index, follow" />
<link rel="canonical" href="https://YOUR-DOMAIN.example/" />
<meta name="theme-color" content="#0b0d12" />

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "الابراج والاستبصار – قراءة الطالع العميقة",
  "description": "قراءات فلكية تنبؤية موجزة",
  "inLanguage": "ar",
  "isPartOf": { "@type": "WebSite", "name": "الابراج والاستبصار", "url": "https://YOUR-DOMAIN.example/" }
}
</script>

<!-- OG / Twitter -->
<meta property="og:locale" content="ar_AR" />
<meta property="og:type" content="website" />
<meta property="og:title" content="الابراج والاستبصار – قراءة الطالع العميقة" />
<meta property="og:description" content="قراءات فلكية تنبؤية موجزة" />
<meta property="og:url" content="https://YOUR-DOMAIN.example/" />
<meta property="og:image" content="https://YOUR-DOMAIN.example/og-image.jpg" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="الابراج والاستبصار – قراءة الطالع العميقة" />
<meta name="twitter:description" content="قراءات فلكية تنبؤية موجزة" />
<meta name="twitter:image" content="https://YOUR-DOMAIN.example/og-image.jpg" />

<!-- خط -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0b0d12; --fg:#f7f7f7; --muted:#bdbdbd;
    --brand:#ffd54a; --card:#141823; --stroke:#242a36; --accent:#5ad1ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:"Cairo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    letter-spacing:0; word-spacing:.2px; line-height:1.85; overflow-x:hidden;
  }

  /* خلفية نجوم خفيفة */
  body::before, body::after{ content:""; position:fixed; inset:0; pointer-events:none; z-index:-2; }
  body::before{
    background:
      radial-gradient(1200px 600px at 50% -10%, #1b2140 0%, rgba(27,33,64,0) 60%),
      radial-gradient(800px 500px at 80% 120%, #1a2336 0%, rgba(26,35,54,0) 60%),
      linear-gradient(180deg, #0b0d12 0%, #0e1320 55%, #0b0d12 100%);
  }
  body::after{
    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="240" height="240" viewBox="0 0 240 240"><g fill="%23ffffff" opacity="0.30"><circle cx="20" cy="30" r="1.2"/><circle cx="80" cy="60" r="0.8"/><circle cx="140" cy="20" r="1"/><circle cx="200" cy="90" r="1.1"/><circle cx="110" cy="140" r="0.9"/><circle cx="40" cy="190" r="1.2"/><circle cx="210" cy="200" r="0.9"/></g></svg>') repeat;
    background-size:240px 240px; animation: twinkle 6s ease-in-out infinite; opacity:.28;
  }
  @keyframes twinkle { 0%,100%{opacity:.20} 50%{opacity:.36} }

  /* الهيدر */
  header{ text-align:center; padding:18px 16px 10px; background:rgba(11,13,18,.75); backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--stroke); }
  .title{ margin:0; font-weight:700; line-height:1.2; font-size: clamp(28px,5vw,46px); color:var(--brand);}
  .subtitle{ color:var(--muted); font-size:14px; margin-top:6px }
  .seer-wrap{display:flex; justify-content:center; margin:10px 0 8px}
  .seer{ width:min(520px, 88vw); height:auto; filter: drop-shadow(0 14px 30px rgba(0,0,0,.4)); }

  .container{max-width:1000px;margin:0 auto;padding:18px 16px}
  .card{ background:rgba(20,24,35,.92); border:1px solid var(--stroke); border-radius:18px; padding:22px; margin:16px 0; box-shadow:0 18px 40px rgba(0,0,0,.35) }
  h2{color:var(--brand); margin:10px 0 8px; text-align:center}
  label{display:block; margin:10px 0 6px; color:#eaeaea; font-size:15px}

  input,select,button{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--stroke);
    background:#0f1320; color:#f7f7f7; font-size:16px; outline:none;
  }
  input:focus, select:focus{border-color:var(--brand); box-shadow:0 0 0 3px rgba(255,213,74,.15)}
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }

  .btn{ border:0; background:linear-gradient(135deg, var(--brand), #ffb300); color:#221; font-weight:700; cursor:pointer; transition:transform .08s ease, filter .2s ease; }
  .btn:active{transform:scale(.99)}
  .ghost{background:transparent; border:1px solid var(--brand); color:var(--brand)}
  .center{display:grid; place-items:center; text-align:center}
  .hidden{display:none !important}

  .topic-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:14px}
  @media (max-width:640px){ .topic-grid{grid-template-columns:1fr} }
  .topic{padding:18px; border:1px dashed var(--brand); border-radius:14px; background:#0f1320; cursor:pointer; text-align:center}
  .topic:hover{background:#12172a}
  .topic span{display:block; color:#cfd8dc; font-size:14px; margin-top:4px}

  .result{ font-size:18px; text-align:justify; text-justify:inter-word; }
  .result p{ margin:10px 0; text-align:justify; }

  .tag{display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px; border:1px solid var(--stroke); color:#fff; font-size:14px; background:#0f1320}
  .z-emoji{font-size:20px}
  .stars{position:relative; overflow:hidden; border-radius:16px}
  .quota{margin-top:8px; font-size:13px; color:#cfd8dc; text-align:center}
  .muted{color:#bdbdbd}

  .notice{ margin:10px auto 0; padding:12px 14px; border-radius:12px; border:1px solid #3a2a2a; background:#1a1010; color:#ffd0d0; font-size:14px; max-width:820px; }
  .notice.ok{background:#0f1a14; border-color:#234832; color:#c9ffd9}

  footer{ padding:24px 16px; text-align:center; color:#cfd8dc; border-top:1px solid var(--stroke); display:flex; flex-direction:column; gap:10px; align-items:center }
  .socials{display:flex; gap:12px; flex-wrap:wrap; justify-content:center}
  .socials button{ width:36px; height:36px; display:inline-grid; place-items:center; border-radius:10px; border:1px solid var(--stroke); background:#0f1320; transition:transform .1s ease, border-color .2s ease; cursor:pointer }
  .socials button:hover{transform:translateY(-1px); border-color:#5ad1ff}
  .socials svg{width:18px;height:18px; fill:#cfd8dc}

  .ring-wrap{height:240px; display:grid; place-items:center}
  .ring{width:120px; height:120px; border-radius:50%; border:6px solid rgba(255,255,255,.08); border-top-color:var(--brand); animation:spin 1.0s linear infinite; position:relative}
  .ring:after{content:""; position:absolute; inset:16px; border-radius:50%; border:4px dashed rgba(255,255,255,.12)}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ===== قالب PDF الرسمي (Print-Only) ===== */
  #printDoc{ display:none; }
  #printDoc .paper{ background:#0b0d12; color:#f7f7f7; border:1px solid #2a3550; border-radius:16px; padding:18px; }
  #printDoc h1{ color:#ffd54a; margin:0 0 6px; text-align:center; font-size:26px; }
  #printDoc h2{ color:#ffd54a; font-size:20px; text-align:center; margin:6px 0 10px; }
  #printDoc .meta{ display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin:10px 0 12px; }
  #printDoc .meta div{ background:#0f1320; border:1px solid #2a3550; border-radius:10px; padding:10px; font-size:14px; }
  #printDoc .reading{ font-size:18px; line-height:1.9; text-align:justify; text-justify:inter-word; }
  #printDoc .brandline{ text-align:center; color:#bdbdbd; font-size:12px; margin-top:12px }
  @media print {
    @page{ size:A4; margin:14mm; }
    html, body { background:#0b0d12; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    header, main > *, footer, .overlay { display:none !important; }
    #printDoc{ display:block !important; }
  }
</style>
</head>
<body>

<header>
  <h1 class="title">الابراج والاستبصار</h1>
  <p class="subtitle">قراءات فلكية تنبؤية موجزة</p>
  <div class="seer-wrap" aria-hidden="true">
    <svg class="seer" viewBox="0 0 800 260" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="g1" cx="50%" cy="50%" r="60%">
          <stop offset="0%" stop-color="#7fd3ff" stop-opacity="0.95"/>
          <stop offset="60%" stop-color="#5ea8ff" stop-opacity="0.35"/>
          <stop offset="100%" stop-color="#1f2a48" stop-opacity="0.0"/>
        </radialGradient>
      </defs>
      <circle cx="400" cy="130" r="70" fill="url(#g1)"/>
      <path d="M320,160 C300,150 280,140 270,130 C260,120 260,110 270,105 C290,95 320,120 340,130" fill="none" stroke="#ffd54a" stroke-width="3" stroke-linecap="round"/>
      <path d="M480,160 C500,150 520,140 530,130 C540,120 540,110 530,105 C510,95 480,120 460,130" fill="none" stroke="#ffd54a" stroke-width="3" stroke-linecap="round"/>
      <g fill="#ffd54a" opacity=".8">
        <circle cx="380" cy="90" r="2"/><circle cx="420" cy="80" r="1.8"/>
        <circle cx="445" cy="115" r="1.6"/><circle cx="355" cy="120" r="1.6"/>
      </g>
    </svg>
  </div>
</header>

<main class="container">

  <div id="globalNotice" class="notice hidden" role="alert"></div>

  <!-- الخطوة 1 -->
  <section id="step1" class="card stars center" aria-labelledby="startTitle">
    <h2 id="startTitle">أدخل بياناتك لبدء القراءة</h2>
    <div class="grid" style="max-width:760px; margin:10px auto 0;">
      <div>
        <label for="gender">الجنس</label>
        <select id="gender" required><option value="">اختر</option><option>ذكر</option><option>أنثى</option></select>
        <div class="notice hidden" id="e_gender">الرجاء اختيار الجنس.</div>
      </div>
      <div>
        <label for="status">الحالة الاجتماعية</label>
        <select id="status" required>
          <option value="">اختر</option>
          <option>أعزب/عزباء</option><option>متزوج/متزوجة</option>
          <option>منفصل/منفصلة</option><option>مخطوب/مخطوبة</option>
        </select>
        <div class="notice hidden" id="e_status">الرجاء اختيار الحالة الاجتماعية.</div>
      </div>
      <div>
        <label for="work">الوضع المهني</label>
        <select id="work" required>
          <option value="">اختر</option>
          <option>أعمل</option><option>عاطل</option><option>طالب</option>
        </select>
        <div class="notice hidden" id="e_work">الرجاء اختيار الوضع المهني.</div>
      </div>
      <div>
        <label for="birthdate">تاريخ الميلاد</label>
        <input id="birthdate" type="date" required>
        <div class="notice hidden" id="e_birthdate">الرجاء إدخال تاريخ الميلاد.</div>
      </div>
    </div>
    <div style="margin-top:16px;">
      <button class="btn" id="startBtn" style="min-width:220px">ابدأ القراءة</button>
    </div>
    <div class="quota" id="quotaInfo"></div>
  </section>

  <!-- انتظار -->
  <section id="stepLoading" class="card hidden center stars" aria-live="polite">
    <div class="ring-wrap"><div class="ring" aria-hidden="true"></div></div>
    <h2>جاري الاستبصار…</h2>
    <p class="muted">ثوانٍ قليلة وتظهر الإشارات.</p>
  </section>

  <!-- اختيار الموضوع -->
  <section id="stepTopics" class="card hidden stars center">
    <h2>اختر موضوع قراءتك</h2>
    <div id="zodiacBadge" style="margin:8px 0 14px"></div>
    <div class="topic-grid" style="max-width:820px; margin:10px auto 0;">
      <button class="topic" data-topic="love">الحب ❤️<span>العلاقات، الانجذاب، المصالحات</span></button>
      <button class="topic" data-topic="health">الصحة 💊<span>الطاقة، العادات، التوازن</span></button>
      <button class="topic" data-topic="career">المهنة والمال 💼<span>الفرص، القرارات، الاستثمارات</span></button>
      <button class="topic" data-topic="general">عام / دراسي ✨<span>رؤية شاملة، امتحانات وزملاء</span></button>
    </div>
    <div class="quota" id="quotaInfoTopics"></div>
  </section>

  <!-- النتيجة -->
  <section id="stepResult" class="card hidden stars">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
      <h2 style="margin:0">الإشارات الظاهرة</h2>
      <div class="tag" id="userEcho"><span class="z-emoji" id="zEmoji">☆</span><span id="zName">—</span></div>
    </div>
    <article id="resultText" class="result" style="margin-top:10px"></article>
    <p id="omen" class="muted" style="margin-top:12px; font-size:15px"></p>

    <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; justify-content:center">
      <button class="ghost" id="topicsBtn">اختيار موضوع آخر</button>
      <button class="ghost" id="restartBtn">إعادة البدء</button>
      <button class="btn" id="printBtn" title="تحميل PDF">تحميل PDF</button>
    </div>
    <div class="quota" id="quotaInfoResult" style="margin-top:10px"></div>
    <p id="printHint" class="muted" style="text-align:center;margin-top:6px;">يتم إنشاء PDF رسمي منظم للهيدر والبيانات والنص فقط.</p>
  </section>

  <noscript>
    <section class="card">
      <h2>قراءة فلكية موجزة</h2>
      <p>هذه صفحة قراءات فلكية عربية مجانية. فعّل JavaScript لاستخدام التجربة التفاعلية وتحديد برجك تلقائيًا.</p>
    </section>
  </noscript>

</main>

<footer>
  <div>شارك الصفحة</div>
  <div class="socials" aria-label="مشاركة">
    <button id="shareNative" title="مشاركة" aria-label="مشاركة">
      <svg viewBox="0 0 24 24" role="img" aria-label="Share"><path d="M18 8a3 3 0 1 0-2.83-3.99L8.91 7.1a3.02 3.02 0 0 0-2.01-.78A3 3 0 1 0 9.9 9l6.26-3.08A3 3 0 0 0 18 8Zm-9 7a3 3 0 1 0-3 3 3 3 0 0 0 3-3Zm12-1a3 3 0 1 0-3 3 3 3 0 0 0 3-3Z"/></svg>
    </button>
    <button id="shareX" title="X / Twitter" aria-label="X">
      <svg viewBox="0 0 24 24" role="img" aria-label="X"><path d="M18.244 2H21l-6.56 7.51L22.5 22h-6.79l-4.87-6.37L4.94 22H2l7.02-8.03L1.5 2h6.87l4.39 5.86L18.244 2Zm-2.38 18h1.84L8.23 4h-1.9l9.534 16Z"/></svg>
    </button>
    <button id="shareWA" title="WhatsApp" aria-label="WhatsApp">
      <svg viewBox="0 0 24 24" role="img" aria-label="WhatsApp"><path d="M12.04 2A10 10 0 0 0 2 12.04C2 17.55 6.46 22 11.97 22c1.76 0 3.43-.43 4.9-1.2l3.13.82-.84-3.06A9.93 9.93 0 0 0 22 12.04 10 10 0 0 0 12.04 2Zm5.86 14.57c-.25.71-1.47 1.35-2.03 1.38-.56.03-1.28.18-4.35-1.42-3.69-1.82-6.06-6.4-6.25-6.69-.19-.29-1.5-2-1.5-3.83 0-1.83.96-2.73 1.3-3.11.34-.38.74-.48.99-.48.25 0 .5 0 .72.01.23.01.55-.09.86.66.31.76 1.06 2.6 1.15 2.79.09.19.16.41.03.66-.13.24-.2.39-.4.6-.19.21-.42.47-.6.63-.19.16-.39.34-.17.72.22.38.97 1.6 2.09 2.6 1.44 1.26 2.66 1.65 3.04 1.84.38.19.6.16.83-.1.23-.25.96-1.12 1.22-1.5.25-.38.51-.32.86-.19.34.13 2.16 1.02 2.54 1.21.38.19.63.28.72.44.09.16.09.94-.16 1.65Z"/></svg>
    </button>
    <button id="shareFB" title="Facebook" aria-label="Facebook">
      <svg viewBox="0 0 24 24" role="img" aria-label="Facebook"><path d="M13 22v-8h3l1-4h-4V7.5A1.5 1.5 0 0 1 14.5 6H17V2h-3.5A4.5 4.5 0 0 0 9 6.5V10H6v4h3v8h4Z"/></svg>
    </button>
  </div>
  <div>© <span id="year"></span> الابراج والاستبصار</div>
</footer>

<!-- مودال الحد اليومي -->
<div class="overlay" id="overlayLimit" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); justify-content:center; align-items:center; z-index:20">
  <div class="modal" style="background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:18px; max-width:520px; margin:16px; text-align:center">
    <h3 style="color:var(--brand); margin-top:0">وصلت إلى الحد اليومي</h3>
    <p>المتاح: <strong>15 قراءة</strong> كل 24 ساعة. الرجاء الانتظار حتى انتهاء العداد لإتاحة قراءات جديدة.</p>
    <p class="quota"><span id="countdown">00:00:00</span> حتى التجديد</p>
    <div class="actions" style="display:flex; gap:10px; justify-content:center; margin-top:10px">
      <button class="ghost" id="closeLimit">حسنًا</button>
    </div>
  </div>
</div>

<!-- قالب PDF الرسمي -->
<div id="printDoc" aria-hidden="true">
  <div class="paper">
    <h1>الابراج والاستبصار</h1>
    <h2>قراءة الطالع العميقة</h2>
    <div class="meta" id="printMeta"></div>
    <div class="reading" id="printReading"></div>
    <div class="brandline">— مستخرج آلي من صفحة الاستبصار —</div>
  </div>
</div>

<script>
  /* سنة الفوتر */
  document.getElementById("year").textContent = new Date().getFullYear();

  /* مشاركة */
  function shareData(){
    const data = { title:"الابراج والاستبصار", text:"قراءات فلكية تنبؤية موجزة", url: location.href };
    if(navigator.share){ navigator.share(data).catch(()=>{}); }
    else { window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}`,'_blank'); }
  }
  document.getElementById("shareNative").addEventListener("click", shareData);
  document.getElementById("shareFB").addEventListener("click", ()=>window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(location.href)}`,'_blank'));
  document.getElementById("shareX").addEventListener("click", ()=>window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent("قراءات فلكية تنبؤية موجزة")}&url=${encodeURIComponent(location.href)}`,'_blank'));
  document.getElementById("shareWA").addEventListener("click", ()=>window.open(`https://wa.me/?text=${encodeURIComponent("قراءات فلكية تنبؤية موجزة: "+location.href)}`,'_blank'));

  const $ = s=>document.querySelector(s);

  /* نطاقات الأبراج */
  const ZODIAC = [
    {name:"الحمل",   emoji:"♈︎", from:[3,21],  to:[4,19]},
    {name:"الثور",   emoji:"♉︎", from:[4,20],  to:[5,20]},
    {name:"الجوزاء", emoji:"♊︎", from:[5,21],  to:[6,20]},
    {name:"السرطان", emoji:"♋︎", from:[6,21],  to:[7,22]},
    {name:"الأسد",   emoji:"♌︎", from:[7,23],  to:[8,22]},
    {name:"العذراء", emoji:"♍︎", from:[8,23],  to:[9,22]},
    {name:"الميزان", emoji:"♎︎", from:[9,23],  to:[10,22]},
    {name:"العقرب",  emoji:"♏︎", from:[10,23], to:[11,21]},
    {name:"القوس",   emoji:"♐︎", from:[11,22], to:[12,21]},
    {name:"الجدي",   emoji:"♑︎", from:[12,22], to:[1,19]},
    {name:"الدلو",   emoji:"♒︎", from:[1,20],  to:[2,18]},
    {name:"الحوت",   emoji:"♓︎", from:[2,19],  to:[3,20]}
  ];
  function getZodiac(dt){
    if(!dt) return {name:"—", emoji:"☆"};
    const d=new Date(dt); if(isNaN(d)) return {name:"—", emoji:"☆"};
    const m=d.getMonth()+1, day=d.getDate();
    for(const z of ZODIAC){
      const [fm,fd]=z.from,[tm,td]=z.to;
      const inSame=(m===fm && day>=fd)||(m===tm && day<=td);
      const inWrap=(fm>tm)&&((m===fm && day>=fd)||(m===tm && day<=td)||(m>fm || m<tm));
      if((fm<tm && inSame)||(fm>tm && inWrap)) return z;
    } return {name:"—", emoji:"☆"};
  }

  /* أوصاف بشرية واسعة (بدون حروف أولى) */
  const DESCRIPTORS = [
    "قصير سريع الحركة", "طويل ذو حضور قوي", "صديق قديم يعود بلا مقدمات", "جار متطفّل يكثر من الأسئلة",
    "قريب حسود يتظاهر بالنصح", "زميل حقود يلمّح ولا يصرّح", "مدرّس أناني يطلب الكثير",
    "شخص هادئ في البداية ثم شديد الصراحة", "مبالغ في الوعود قليل في التنفيذ", "عملي لا يحب التفاصيل الطويلة",
    "غامض في سيرته واضح في فعله", "قريب عبوس يغيّر رأيه بسرعة", "زميل متملّق ينتظر مكسبًا سهلًا",
    "جار طيب لكنه كثير الكلام", "شخص يظهر بقوة ثم يختفي أيامًا", "زميل منافس يتصنّع الود",
    "قريب منطقي لكنه بارد", "شريك محتمل يحب السيطرة", "مدرّس متطلب يفاجئك باختبار",
    "طالب كسول يحاول الاتكاء عليك", "صاحب مبادرات صغيرة وثابتة", "شخص متسرّع يُربك المواعيد",
    "هادئ الطباع يكره الدراما", "صديق عملي يدعمك بالأفعال", "قريب حاقد يهوّل الأحداث",
    "زميل مرتبك ينقل كلامًا ناقصًا", "جار ودود يحترم الخصوصية", "شخص متأرجح بين الود والصد",
    "مدرّس يعطي تلميحات بدل الحلول", "زميل يغار من إنجازك الأخير"
  ];

  /* قوالب نصية عميقة (سيجري توليد ≥25/موضوع = 100+) */
  const TEMPLATES = {
    love: [
      "تتقاطع اليوم إشارات عاطفية ناضجة؛ الفعل الصادق يتكرّر دون طلب، والكلام الزائد يتساقط من تلقاء نفسه.",
      "مصالحة ممكنة بعد توتّر قصير؛ جملة دقيقة تُغلق باب التأويل وتعيد حرارة الحوار.",
      "باب تعارف يخرج من طريقٍ مهني/دراسي؛ لا تمنحه وعدًا كبيرًا مبكّرًا، دع الوقت يثبت جدّيته.",
      "غيرة خفيفة عند الأطراف تُطفَأ بابتسامة وشفافية؛ لا مجال للهمس حين تكون اللغة واضحة.",
      "رسالة تُؤجَّل ثم تصل في التوقيت المناسب؛ قوّتها في توقيتها لا في طولها.",
      "توقّع دعمًا فعليًا من صديق عملي؛ يقدّم فعلًا صغيرًا يغيّر يومًا كاملًا.",
      "تحذير: وجود شخص {desc} قد يخلط الود بالمصلحة؛ لا توقّعًا بلا اختبار.",
      "العاطفة تنضج عندما تُحترم الحدود؛ من لا يحترمها اليوم سيكسرها غدًا.",
      "لقاء خاطف يعيد إحياء فكرة قديمة؛ لا تستعجل التسمية، راقب الثبات.",
      "اعتذارٌ صريح يردّ لك يقينك؛ العبرة بما بعد الاعتذار لا به وحده."
    ],
    career: [
      "مهمة متوسطة بموعدٍ ضيق تُظهرك في المكان الصحيح؛ الإنجاز هنا يفتح توصية غير متوقعة.",
      "بند صغير في ورقة كبيرة يحتاج قراءة مرتين؛ يمنع تأخيرًا مزعجًا.",
      "تذبذبٌ قصير في سوق/راتب؛ السيولة القصيرة تحمي من انعطافة مفاجئة.",
      "نافذة تعلّم سريعة ترفع ثقتك خلال أسبوع؛ ساعة يوميًا تكفي للفرق.",
      "اجتماع محدد الهدف: إجابتان واضحتان وسؤال ذكي واحد يصنعان الثقة.",
      "فرصة جانبية بوقع كبير؛ ابدأ صغيرًا وثبّت الجودة ثم وسّع.",
      "تحذير: شريك {desc} يلمّع العرض ويخفي التفصيل؛ أخرج البنود إلى الضوء.",
      "زيادة دخل من مسار ثانوي؛ الاستمرارية تهزم القفزات.",
      "خلاف مهني قصير يهدأ بالأرقام لا بالانفعال.",
      "أثر عمل قديم يعود بتوصية جديدة؛ الانطباع لا يموت سريعًا."
    ],
    health: [
      "صفاء داخلي يعيد نومًا أعمق حين يخف الضوء مساءً.",
      "ألم كتفين/أسفل ظهر إشارة مبكرة؛ دقيقة تمدد بين كل مهمتين تكفي.",
      "ماء وحركة خفيفة صباحًا تصنع طاقة واضحة خلال ٤٨ ساعة.",
      "توتر عابر يهدأ باستراحات قصيرة متكررة.",
      "المشي الهادئ خارج الشاشة يعيد تركيزك لنقطة الصفر.",
      "تقليل المنبّهات ليلًا يمنع تذبذب النوم.",
      "تحذير: محيط فيه شخص {desc} يزيد التشتت؛ اضبط حدودك.",
      "الاستمرارية الصغيرة تهزم الحماس المتقطّع.",
      "قول المخاوف بصوت مسموع يقلّل حدتها للنصف.",
      "وجبة أولى أخفّ تُحسّن صفاء الذهن بقية اليوم."
    ],
    general: [
      "خبر سار يقترب خطوة بخطوة كأنه يعوّض انتظارًا طويلًا.",
      "مصادفة دقيقة تجمع فكرة كبيرة بلقاءٍ قصير.",
      "نقاشٌ عائلي حادّ وقصير يهدأ بالإنصات لا بالاتهام.",
      "مبلغ صغير/متوسط يظهر بلا موعد ويخفف عبئًا قديمًا.",
      "رسالة مقتضبة تغيّر اتجاه الأسبوع بالكامل.",
      "تحذير: شخص {desc} يختبر حدودك؛ الصرامة اللطيفة تحميك.",
      "الحدس يسبق الكلام؛ التوقيت نصف اليقين.",
      "حين تُكتب الأهداف بسطرين تنتهي المتاهة وتبدأ الحركة.",
      "بابان سيُطرقان: الأول امتحان، والثاني فرج.",
      "في الدراسة: زميل {desc} يحاول التشتيت؛ خطتك المنتظمة أقوى من كلامه."
    ]
  };

  /* بناء ≥25 تنويعًا/موضوع = 100+ إجمالي (مع مزج الأوصاف) */
  function buildTopicVariants(topic){
    const base = TEMPLATES[topic] || TEMPLATES.general;
    const variants = [];
    let id = 1;
    for(const t of base){
      // نمزج كل قالب مع مجموعة أوصاف لتكثير التنوع
      for(let i=0;i<DESCRIPTORS.length;i+=Math.max(1, Math.ceil(DESCRIPTORS.length/3))){
        const desc = DESCRIPTORS[i];
        const txt = t.replace("{desc}", desc);
        variants.push({id:`${topic}-${id++}`, text:txt});
      }
    }
    // ضمان ≥ 25
    while(variants.length<25){
      const desc = DESCRIPTORS[Math.floor(Math.random()*DESCRIPTORS.length)];
      const t = base[Math.floor(Math.random()*base.length)].replace("{desc}", desc);
      variants.push({id:`${topic}-${id++}`, text:t});
    }
    // خلط واختيار 25
    variants.sort(()=>Math.random()-0.5);
    return variants.slice(0,25);
  }

  // بنك كامل (100+) يُنشأ عند التشغيل
  const BANK = {
    love:   buildTopicVariants('love'),
    career: buildTopicVariants('career'),
    health: buildTopicVariants('health'),
    general:buildTopicVariants('general')
  };

  /* عناصر الواجهة */
  const step1=$("#step1"), stepLoading=$("#stepLoading"), stepTopics=$("#stepTopics"), stepResult=$("#stepResult");
  const globalNotice=$("#globalNotice");
  const zodiacBadge=$("#zodiacBadge"), zEmojiEl=$("#zEmoji"), zNameEl=$("#zName");
  const resultText=$("#resultText"), omenEl=$("#omen"), userEcho=$("#userEcho");
  const overlayLimit=$("#overlayLimit"), countdownEl=$("#countdown");
  const quotaInfo=$("#quotaInfo"), quotaInfoTopics=$("#quotaInfoTopics"), quotaInfoResult=$("#quotaInfoResult");
  document.getElementById("closeLimit").addEventListener("click", ()=> overlayLimit.style.display="none");

  /* حفظ/تحميل النموذج */
  function saveForm(){ localStorage.setItem("istibsar_form", JSON.stringify({
    gender: $("#gender").value||"", status: $("#status").value||"", work: $("#work").value||"", birthdate: $("#birthdate").value||""
  })); }
  function loadForm(){ try{ const d=JSON.parse(localStorage.getItem("istibsar_form")||"{}");
    if(d.gender) $("#gender").value=d.gender; if(d.status) $("#status").value=d.status;
    if(d.work) $("#work").value=d.work; if(d.birthdate) $("#birthdate").value=d.birthdate;
  }catch(e){} }

  let currentSign={name:"—",emoji:"☆"};
  function updateZodiacUI(){
    const bd=$("#birthdate").value; currentSign=getZodiac(bd);
    zEmojiEl.textContent=currentSign.emoji; zNameEl.textContent=currentSign.name;
    zodiacBadge.innerHTML=`<div class="tag"><span class="z-emoji">${currentSign.emoji}</span> برجك: ${currentSign.name}</div>`;
  }
  ["gender","status","work","birthdate"].forEach(id=>{
    const el=$("#"+id);
    el.addEventListener("input", ()=>{ saveForm(); updateZodiacUI(); });
    el.addEventListener("change", ()=>{ saveForm(); updateZodiacUI(); });
    el.addEventListener("blur",  ()=>{ saveForm(); updateZodiacUI(); });
    if(id==="birthdate"){ el.addEventListener("keyup", updateZodiacUI); el.addEventListener("click", ()=>setTimeout(updateZodiacUI,0)); }
  });

  /* حد 15 قراءة/24 ساعة */
  const MAX_READS=15;
  function getQuota(){ const raw=localStorage.getItem("istibsar_quota"), now=Date.now(); if(!raw) return {count:0, resetAt:null};
    try{ const q=JSON.parse(raw); if(q.resetAt && now>q.resetAt) return {count:0, resetAt:null}; return q; }catch(e){ return {count:0, resetAt:null}; } }
  function setQuota(q){ localStorage.setItem("istibsar_quota", JSON.stringify(q)); }
  function incQuota(){ const q=getQuota(); const now=Date.now(); const resetAt=q.resetAt||(now+24*60*60*1000); const next={count:(q.count||0)+1, resetAt}; setQuota(next); return next; }
  function remainingQuota(){ const q=getQuota(); return Math.max(0, MAX_READS-(q.count||0)); }
  function fmtRemaining(ms){ if(ms<=0) return "00:00:00"; const s=Math.floor(ms/1000), h=String(Math.floor(s/3600)).padStart(2,"0"), m=String(Math.floor((s%3600)/60)).padStart(2,"0"), sc=String(s%60).padStart(2,"0"); return `${h}:${m}:${sc}`; }
  function updateQuotaUI(){ const rem=remainingQuota(); const q=getQuota(); const base=`المتبقي اليوم: ${rem} / ${MAX_READS}`+(q.resetAt?` — تجديد خلال ${fmtRemaining(q.resetAt - Date.now())}`:""); [quotaInfo,quotaInfoTopics,quotaInfoResult].forEach(el=>{ if(el) el.textContent=base; }); }
  function showLimitOverlay(){ const q=getQuota(); if(!q.resetAt) return; overlayLimit.style.display="flex"; (function tick(){ const left=q.resetAt-Date.now(); countdownEl.textContent=fmtRemaining(left); if(left<=0){ overlayLimit.style.display="none"; setQuota({count:0, resetAt:null}); updateQuotaUI(); } else { requestAnimationFrame(tick); } })(); }

  /* إشعار */
  function showGlobal(msg, ok=false){ globalNotice.textContent=msg; globalNotice.classList.toggle("ok", ok); globalNotice.classList.remove("hidden"); setTimeout(()=>{ globalNotice.classList.add("hidden"); globalNotice.classList.remove("ok"); }, 3200); }

  /* تحقق الإدخال */
  function validateForm(){
    let ok=true; const g=$("#gender").value.trim(), s=$("#status").value.trim(), w=$("#work").value.trim(), b=$("#birthdate").value.trim();
    ["e_gender","e_status","e_work","e_birthdate"].forEach(id=>$("#"+id).classList.add("hidden"));
    if(!g){ $("#e_gender").classList.remove("hidden"); ok=false; }
    if(!s){ $("#e_status").classList.remove("hidden"); ok=false; }
    if(!w){ $("#e_work").classList.remove("hidden"); ok=false; }
    if(!b){ $("#e_birthdate").classList.remove("hidden"); ok=false; }
    if(!ok){ showGlobal("الرجاء إكمال البيانات المطلوبة للمتابعة."); }
    return ok;
  }

  /* مفتاح المستخدم لمنع التكرار */
  function userKey(){
    const form = JSON.stringify({g:$("#gender").value||"", s:$("#status").value||"", w:$("#work").value||"", b:$("#birthdate").value||""});
    let h=2166136261>>>0; for(let i=0;i<form.length;i++){ h^=form.charCodeAt(i); h=Math.imul(h,16777619); }
    return h.toString(16);
  }
  function getUsed(topic){
    const key = `istibsar_used_${userKey()}_${topic}`;
    try{ return new Set(JSON.parse(localStorage.getItem(key) || "[]")); }catch(_){ return new Set(); }
  }
  function addUsed(topic, id){
    const key = `istibsar_used_${userKey()}_${topic}`;
    const s = getUsed(topic); s.add(id);
    localStorage.setItem(key, JSON.stringify([...s]));
  }

  /* اختيار تنويع غير مكرر */
  function pickUniqueVariant(topic){
    const list = BANK[topic] || BANK.general;
    const used = getUsed(topic);
    const pool = list.filter(v=> !used.has(v.id));
    if(pool.length===0){
      showGlobal("تم استهلاك كل التنويعات المتاحة لهذا الموضوع. سيُعاد التوليف من جديد.", true);
      localStorage.removeItem(`istibsar_used_${userKey()}_${topic}`);
      return list[Math.floor(Math.random()*list.length)];
    }
    return pool[Math.floor(Math.random()*pool.length)];
  }

  /* توليف قراءة كاملة (بلا افتتاحية ثابتة) */
  function composeReading(topic){
    const main = pickUniqueVariant(topic);
    addUsed(topic, main.id);

    const family = [
      "خلافٌ عائلي قصير لكنه حادّ يهدأ سريعًا إذا تُرك مجال للإنصات لا للاتهام.",
      "جلسة هادئة تكشف لبسًا قديمًا وتُنهي سوء فهم متراكم دون خسائر."
    ];
    const money = [
      "وارد مالي غير متوقّع (استرداد/هبة/ربح جانبي) يخفّف عبئًا سابقًا؛ تجنّب الإنفاق المتعجّل ليومين.",
      "فرصة توفير ذكية تظهر كاشتراك يمكن إعادة التفاوض عليه لتقليل الكلفة."
    ];
    const person = [
      `وجود شخص ${DESCRIPTORS[Math.floor(Math.random()*DESCRIPTORS.length)]} يختبر حدودك؛ الصرامة اللطيفة تحميك.`,
      `تأثير شخص ${DESCRIPTORS[Math.floor(Math.random()*DESCRIPTORS.length)]} يظهر سريعًا؛ اجعل المعيار فعلًا لا وعدًا.`
    ];

    const parts = [
      `<p>${main.text}</p>`,
      `<p><strong>العائلة:</strong> ${family[Math.floor(Math.random()*family.length)]}</p>`,
      `<p><strong>المال/العمل:</strong> ${money[Math.floor(Math.random()*money.length)]}</p>`,
      `<p><strong>شخص في المدار:</strong> ${person[Math.floor(Math.random()*person.length)]}</p>`,
      `<p><em>ومضة:</em> الباب الأول امتحان، والثاني فرج. توقيت الرد نصف اليقين.</p>`
    ];
    return parts.join("");
  }

  /* تدفّق الواجهات */
  const stepSequence = { show: el=>el.classList.remove("hidden"), hide: el=>el.classList.add("hidden") };

  function echoUser(){
    const g=$("#gender").value||"—", s=$("#status").value||"—", w=$("#work").value||"—", b=$("#birthdate").value||"—";
    $("#userEcho").innerHTML=`<span class="z-emoji">${currentSign.emoji}</span> ${currentSign.name} • ${g} • ${s} • ${w} • ${b}`;
  }

  function startFlow(){
    if(!validateForm()) return;
    stepSequence.hide(step1); stepSequence.show(stepLoading);
    setTimeout(()=>{ stepSequence.hide(stepLoading); stepSequence.show(stepTopics); updateZodiacUI(); updateQuotaUI(); }, 1100);
  }

  function runTopic(topic){
    if(remainingQuota()<=0){ updateQuotaUI(); showLimitOverlay(); return; }
    stepSequence.hide(stepTopics); stepSequence.show(stepLoading);
    setTimeout(()=>{
      stepSequence.hide(stepLoading); stepSequence.show(stepResult);
      incQuota(); updateQuotaUI(); echoUser();
      $("#resultText").innerHTML = composeReading(topic);
      $("#omen").textContent = ["ومضة: رسالة مقتضبة تغيّر اتجاه الأسبوع.","ومضة: لقاء عابر يترك أثرًا أطول من زمنه.","ومضة: باب يُفتح مرتين؛ الأولى امتحان، والثانية فرج."][Math.floor(Math.random()*3)];
    }, 1100);
  }

  $("#startBtn").addEventListener("click", startFlow);
  document.querySelectorAll(".topic").forEach(btn=> btn.addEventListener("click", ()=> runTopic(btn.dataset.topic)));
  $("#topicsBtn").addEventListener("click", ()=>{ stepSequence.hide(stepResult); stepSequence.show(stepTopics); updateQuotaUI(); });
  $("#restartBtn").addEventListener("click", ()=>{ stepSequence.hide(stepResult); stepSequence.hide(stepTopics); stepSequence.show(step1); window.scrollTo({top:0, behavior:"smooth"}); updateQuotaUI(); });

  /* PDF رسمي */
  function buildPrintDoc(){
    const meta=$("#printMeta"), reading=$("#printReading");
    const g=$("#gender").value||"—", s=$("#status").value||"—", w=$("#work").value||"—", b=$("#birthdate").value||"—";
    const now=new Date(); const when=now.toLocaleString('ar', {hour12:false});
    meta.innerHTML = `
      <div>البرج: ${currentSign.emoji} ${currentSign.name}</div>
      <div>الجنس: ${g}</div>
      <div>الحالة الاجتماعية: ${s}</div>
      <div>الوضع المهني: ${w}</div>
      <div>تاريخ الميلاد: ${b}</div>
      <div>تاريخ الإصدار: ${when}</div>
    `;
    reading.innerHTML = $("#resultText").innerHTML;
  }
  $("#printBtn").addEventListener("click", ()=>{
    if($("#stepResult").classList.contains("hidden")){ showGlobal("أكمل القراءة أولًا ثم حمّل PDF."); return; }
    buildPrintDoc(); window.print();
  });

  /* تهيئة */
  (function init(){ updateZodiacUI(); updateQuotaUI(); loadForm(); })();
</script>
</body>
</html>
