<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ | Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ</title>
<meta name="description" content="Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŒ ÙˆØ¹Ø¯Ù‘Ø§Ø¯ Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…ØŒ ÙˆØªØ§Ø±ÙŠØ® Ù‡Ø¬Ø±ÙŠ Ù…Ø¹ ØªØ¹ÙˆÙŠØ¶.">
<link rel="canonical" href="">
<link rel="alternate" hreflang="ar" href="">

<!-- Open Graph / Twitter -->
<meta property="og:type" content="website">
<meta property="og:title" content="Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¬Ø¹ÙØ±ÙŠØ© Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ">
<meta property="og:description" content="Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø£ÙŠÙ†Ù…Ø§ ÙƒÙ†Øª Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ÙˆØ§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø°ÙƒÙŠ.">
<meta property="og:locale" content="ar_AR">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ø¬Ø¹ÙØ±ÙŠØ© Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ">
<meta name="twitter:description" content="Ù…ÙˆØ§Ù‚ÙŠØª Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ + Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ + Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù….">

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@600&family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">

<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ",
  "applicationCategory": "UtilitiesApplication",
  "operatingSystem": "Web",
  "inLanguage": "ar",
  "description": "Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ Ù…Ø­Ø³ÙˆØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ.",
  "url": "",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "featureList": [
    "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§",
    "Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠ Ø¹Ù† Ø§Ù„Ù…Ø¯Ù† ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹",
    "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ÙˆÙÙ‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª",
    "ØªØ¹ÙˆÙŠØ¶ Ù„Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ",
    "Ø¹Ø¯Ù‘Ø§Ø¯ Ù„Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…",
    "ØªØ­Ø³ÙŠÙ†Ø§Øª SEO"
  ]
}
</script>

<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --bg:#f7fafc; --card:#ffffff; --border:#e5e7eb;
    --accent:#0ea5a6; --accent-ink:#063f3f; --shadow:0 10px 30px rgba(2,6,23,.08);
    --hadith-color:#0d2a58;
  }
  @media (prefers-color-scheme: dark){
    :root{ --ink:#e5e7eb; --muted:#94a3b8; --bg:#0b1220; --card:#0f172a; --border:#1f2937; --shadow:none; --hadith-color:#a7c0ff; }
    .ico{ background:#0b2a2a; }
    th{ background:#0e1726; }
    .cd-seg{ background:#0b1220; }
    .changeBtn{ background:#0b2536; color:#e5e7eb; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--ink); padding:16px;}
  .container{width:min(1100px,100%); margin:auto; display:flex; flex-direction:column; gap:18px}

  .topClock{display:flex; justify-content:flex-end; gap:10px; font-size:.95rem; font-weight:800; color:var(--accent-ink)}
  .hero{background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); padding:20px; text-align:center}
  .heroTitle{margin:0; font-family:"Reem Kufi",sans-serif; font-size:1.6rem; color:var(--ink); letter-spacing:.2px}

  .locationBox{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:12px 14px; display:flex; justify-content:space-between; align-items:center; gap:10px}
  .place{font-weight:800; font-size:1.05rem}
  .changeBtn{border:1px solid var(--border); padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer; background:#eef6ff}
  .subPlace{font-size:.88rem; color:var(--muted)}

  .bar{display:flex; gap:8px; flex-wrap:wrap}
  .miniBtn{border:1px solid var(--border); background:var(--card); padding:.45rem .75rem; border-radius:10px; font-weight:800; cursor:pointer}
  .miniBtn.primary{background:#e6fffb; border-color:#b6f3ec}

  .nextBox{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:16px; display:grid; gap:10px}
  .nextTitle{font-weight:900; color:var(--accent-ink); text-align:center; letter-spacing:.3px}
  .nextRow{display:flex; justify-content:space-between; align-items:center; font-weight:800}
  .nextName{font-size:1.07rem}
  .nextAt{font-variant-numeric:tabular-nums}
  .countdown{display:flex; justify-content:center; gap:10px; font-weight:900; font-size:1.6rem; letter-spacing:.5px; direction:ltr}
  .cd-seg{min-width:2ch; text-align:center; padding:.25rem .6rem; border:1px solid var(--border); border-radius:10px; background:#f8fafc}
  .cd-colon{opacity:.6}
  .note{font-size:.9rem; color:var(--muted); text-align:center}

  .infoRow{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media(max-width:720px){.infoRow{grid-template-columns:1fr}}
  .chip{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:12px; display:flex; align-items:center; gap:12px}
  .ico{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:#eef2ff; font-size:1.2rem}
  .stack{display:flex; flex-direction:column}
  .label{font-size:.86rem; color:var(--muted); font-weight:800}
  .value{font-weight:900; font-size:1.02rem; font-variant-numeric:tabular-nums}

  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:12px}
  .card h3{margin:0 0 10px; font-size:1.05rem; font-weight:900; text-align:center;}
  table{width:100%; border-collapse:collapse}
  th,td{padding:12px; border-bottom:1px solid #eef2f7; font-size:1rem}
  th{background:#fafafa; font-weight:900}
  td.name{text-align:right; font-weight:800}
  td.time{text-align:left; font-weight:900}
  tr.next td{background:linear-gradient(90deg,#0ea5a61a,transparent)}

  .events{display:none; background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:14px}
  .events h3{margin:0 0 8px; font-size:1.02rem; font-weight:900; text-align:center;}
  .evtGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:720px){.evtGrid{grid-template-columns:1fr}}
  .evtCol{border:1px dashed #e3e8f0; border-radius:10px; padding:10px}
  .evtCol h4{margin:0 0 6px; font-size:.95rem; color:var(--ink)}
  .evtItem{padding:6px 0; border-bottom:1px solid #f0f0f0}
  .evtItem:last-child{border-bottom:none}
  .evtText{font-weight:800}

  .hadith{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); padding:16px; text-align:center}
  .htext{margin:0; font-size:1.08rem; color:var(--hadith-color); line-height:1.9}
  .hsrc{display:inline-block; margin-top:12px; padding:6px 14px; border-radius:10px; background:#f5f7fa; border:1px solid var(--border); font-weight:800; color:#3b4656}

  footer{text-align:center; margin-top:8px}
  .credit{color:var(--hadith-color); font-weight:800}

  /* Modal */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(15,23,42,.28); z-index:60}
  .modal.open{display:grid}
  .box{width:min(620px,96%); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .rowCtrl{display:flex; gap:10px; align-items:center; margin:10px 0}
  .rowCtrl label{width:120px; color:var(--muted); font-weight:800}
  .actions{display:flex; gap:10px; margin-top:12px; justify-content:flex-start; flex-wrap:wrap}
  .btn{border:1px solid var(--border); border-radius:10px; padding:.55rem .9rem; font-weight:900; cursor:pointer; background:var(--card)}
  .btn.primary{background:#e6fffb}
  input[type="text"]{flex:1; padding:12px; border-radius:12px; border:1px solid var(--border); font-weight:700; background:transparent; color:var(--ink)}
  .hint{font-size:.86rem; color:var(--muted)}
  .results{max-height:270px; overflow:auto; border:1px dashed var(--border); border-radius:12px; padding:6px}
  .resItem{padding:10px; border-bottom:1px solid #eef2f7; cursor:pointer}
  .resItem:last-child{border-bottom:none}
  .resCap{font-weight:800}
  .resSub{font-size:.86rem; color:var(--muted)}
  .small{font-size:.85rem; color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <div class="topClock">
      <span id="topClock">--:-- --</span>
    </div>

    <section class="hero" aria-labelledby="title">
      <h1 id="title" class="heroTitle">Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ</h1>
      <div class="small">Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§ØªØŒ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§.</div>
    </section>

    <div class="locationBox" aria-live="polite">
      <div>
        <div class="place" id="place">â€”</div>
        <div class="subPlace" id="subPlace"></div>
      </div>
      <div class="bar">
        <button class="miniBtn primary" id="useGeo" type="button">ğŸ“ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ</button>
        <button class="changeBtn" id="openPicker" type="button">ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      </div>
    </div>

    <section class="nextBox" id="nextBox">
      <div class="nextTitle">Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…</div>
      <div class="nextRow">
        <span class="nextName" id="nextName">--</span>
        <span class="nextAt" id="nextAt">--:-- --</span>
      </div>
      <div class="countdown" aria-live="polite">
        <span class="cd-seg" id="cdH">00</span><span class="cd-colon">:</span>
        <span class="cd-seg" id="cdM">00</span><span class="cd-colon">:</span>
        <span class="cd-seg" id="cdS">00</span>
      </div>
      <div class="note" id="nextNote"></div>
    </section>

    <section class="infoRow" aria-label="Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®">
      <div class="chip">
        <div class="ico">ğŸ—“</div>
        <div class="stack"><div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ</div><div class="value" id="hijri">--</div></div>
      </div>
      <div class="chip">
        <div class="ico">ğŸ“…</div>
        <div class="stack"><div class="label">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ</div><div class="value" id="greg">--</div></div>
      </div>
    </section>

    <section class="card" aria-label="Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ">
      <h3>Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
      <table>
        <thead><tr><th>Ø§Ù„Ø­Ø¯Ø«</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
        <tbody id="times"><tr><td colspan="2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr></tbody>
      </table>
    </section>

    <section class="events" id="eventsBox">
      <h3>Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="evtGrid">
        <div class="evtCol" id="colToday"><h4>Ø§Ù„ÙŠÙˆÙ…</h4><div id="eventsToday"></div></div>
        <div class="evtCol" id="colNight"><h4>Ø§Ù„Ù„ÙŠÙ„Ø©</h4><div id="eventsTonight"></div></div>
      </div>
    </section>

    <section class="hadith" aria-label="Ø­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ…">
      <p class="htext" id="hadithText"></p>
      <div class="hsrc" id="hadithSource"></div>
    </section>

    <footer><span class="credit">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± ÙØ§Ø¶Ù„ Ø§Ù„Ø±ÙŠØ³</span></footer>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© -->
  <div class="modal" id="modal" aria-modal="true" role="dialog">
    <div class="box">
      <div class="rowCtrl">
        <label for="q">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹</label>
        <input id="q" type="text" placeholder="Ù…Ø«Ø§Ù„: Manama, Jeddah, London, 24.47, 39.61">
      </div>
      <div class="hint">ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø¯ÙŠÙ†Ø©/Ù…Ù†Ø·Ù‚Ø© Ø¨Ø£ÙŠ Ù„ØºØ©ØŒ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (lat,lon).</div>
      <div class="rowCtrl">
        <div class="results" id="results" aria-live="polite"></div>
      </div>
      <div class="rowCtrl">
        <label for="hijriOffsetSel">ØªØ¹ÙˆÙŠØ¶ Ø§Ù„Ù‡Ø¬Ø±ÙŠ</label>
        <select id="hijriOffsetSel">
          <option value="-2">-2 ÙŠÙˆÙ…</option>
          <option value="-1">-1 ÙŠÙˆÙ…</option>
          <option value="0" selected>Ø¨Ø¯ÙˆÙ† ØªØ¹ÙˆÙŠØ¶</option>
          <option value="1">+1 ÙŠÙˆÙ…</option>
          <option value="2">+2 ÙŠÙˆÙ…</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn primary" id="closePicker" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        <button class="btn" id="clearSaved" type="button">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸</button>
      </div>
    </div>
  </div>

<script>
/* ========================= SEO: Ø¶Ø¨Ø· canonical/alternate Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ ========================= */
document.querySelector('link[rel="canonical"]').setAttribute('href', location.href.split('#')[0]);
document.querySelector('link[rel="alternate"]').setAttribute('href', location.href.split('#')[0]);

/* ========================= Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† ========================= */
const DEFAULT = { nameAr:"Ø§Ù„Ù…Ù†Ø§Ù…Ø©ØŒ Ø§Ù„Ø¨Ø­Ø±ÙŠÙ†", nameEn:"Manama, Bahrain", lat:26.2235, lon:50.5876, tz:"Asia/Bahrain" };
let state = JSON.parse(localStorage.getItem("pr_times_state")||"null") || {...DEFAULT};
let HIJRI_OFFSET_DAYS = Number(localStorage.getItem("pr_hijri_offset_days")||"0");
let lastTimings = null;
let cdTimer = null;

/* ========================= Ù†ØµÙˆØµ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø«Ø§Ø¨ØªØ© ========================= */
const NAMES = {
  Imsak:"Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ", Fajr:"Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø±", Sunrise:"Ø§Ù„Ø´Ø±ÙˆÙ‚",
  Dhuhr:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¸Ù‡Ø±", Asr:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹ØµØ±", Sunset:"Ø§Ù„ØºØ±ÙˆØ¨",
  Maghrib:"Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨", Isha:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø´Ø§Ø¡", Midnight:"Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„"
};
const HADITHS=[
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø¨Ø§Ù‚Ø± (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØµÙ„ÙŠ Ø§Ù„Ù‚Ø¨Ù„Ø© Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø±Ø­Ù…Ù† Ø¨ÙˆØ¬Ù‡Ù‡ Ù„Ø§ Ø¥Ù„Ù‡ ØºÙŠØ±Ù‡.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ø±Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ„Ø§Ø© Ø£Ù‚Ø¨Ù„ Ø¥Ø¨Ù„ÙŠØ³ ÙŠÙ†Ø¸Ø± Ø¥Ù„ÙŠÙ‡ Ø­Ø³Ø¯Ø§Ù‹ Ù„Ù…Ø§ ÙŠØ±Ù‰ Ù…Ù† Ø±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ Ø§Ù„ØªÙŠ ØªØºØ´Ø§Ù‡.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø±Ø¶Ø§ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„ØµÙ„Ø§Ø© Ù„Ù‡Ø§ Ø£Ø±Ø¨Ø¹Ø© Ø¢Ù„Ø§Ù Ø¨Ø§Ø¨.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø§Ù„Ø¥Ù…Ø§Ù… Ø¹Ù„ÙŠ (Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…): ÙŠØ§ ÙƒÙ…ÙŠÙ„! Ù„ÙŠØ³ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªØµÙ„ÙŠ ÙˆØªØµÙˆÙ… ÙˆØªØªØµØ¯Ù‚ØŒ Ø¥Ù†Ù…Ø§ Ø§Ù„Ø´Ø£Ù† Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„ØµÙ„Ø§Ø© ÙØ¹Ù„Øª Ø¨Ù‚Ù„Ø¨ Ù†Ù‚ÙŠØŒ ÙˆØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù‡ Ù…Ø±Ø¶ÙŠØŒ ÙˆØ®Ø´ÙˆØ¹ Ø³ÙˆÙŠ.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø­ÙƒÙ…Ø©"},
  {t:"Ù‚Ø§Ù„ Ø±Ø³ÙˆÙ„ Ø§Ù„Ù„Ù‡ ØµÙ„Ù‰ Ø§Ù„Ù„Ù‡ Ø¹Ù„ÙŠÙ‡ ÙˆØ¢Ù„Ù‡: Ù…Ù† ØªØ±Ùƒ ØµÙ„Ø§ØªÙ‡ Ù…ØªØ¹Ù…Ø¯Ø§Ù‹ ÙÙ‚Ø¯ Ù‡Ø¯Ù… Ø¯ÙŠÙ†Ù‡â€¦",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±"},
  {t:"Ù‚Ø§Ù„ Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ù‡ Ø¨Ù† Ù…Ø³Ø¹ÙˆØ¯: Ø£ÙŠÙ‘ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø£Ø­Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‡ØŸ Ù‚Ø§Ù„: Ø§Ù„ØµÙ„Ø§Ø© Ù„ÙˆÙ‚ØªÙ‡Ø§.",s:"Ø§Ù„Ù…ØµØ¯Ø±: Ø§Ù„Ø®ØµØ§Ù„"}
];
const HIJRI_MONTHS_AR=["","Ù…Ø­Ø±Ù…","ØµÙØ±","Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„","Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø®Ø±","Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰","Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©","Ø±Ø¬Ø¨","Ø´Ø¹Ø¨Ø§Ù†","Ø±Ù…Ø¶Ø§Ù†","Ø´ÙˆØ§Ù„","Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©","Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©"];

/* ========================= Ø£Ø¯ÙˆØ§Øª ÙˆÙ‚Øª/ØªÙ†Ø³ÙŠÙ‚ ========================= */
function to12h(raw){
  if(!raw) return "--:-- --";
  const pure=String(raw).replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(pure)) return raw;
  let [H,M]=pure.split(":").map(Number);
  H = (H===24)?0:H;
  const h=H%12||12; return `${h}:${String(M).padStart(2,"0")} ${H<12?"AM":"PM"}`;
}
function updateClock(){
  const tz = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
  topClock.textContent=new Intl.DateTimeFormat('en-GB',{timeZone:tz,hour:'2-digit',minute:'2-digit',hour12:true}).format(new Date());
}
setInterval(updateClock,1000); updateClock();

/* ØªØ­ÙˆÙŠÙ„Ø§Øª Ù‡Ø¬Ø±ÙŠ Ù…Ø­Ù„ÙŠØ© (fallback) */
function hasIntlIslamic(){ try{ new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'numeric'}).format(new Date()); return true; }catch{ return false; } }
function ymdInTZ(date, tz){
  const p=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
  return {Y:p.find(x=>x.type==='year').value, M:p.find(x=>x.type==='month').value, D:p.find(x=>x.type==='day').value};
}
function g2jd(y,m,d){ const a=Math.floor((14-m)/12); y=y+4800-a; m=m+12*a-3; return d + Math.floor((153*m+2)/5) + 365*y + Math.floor(y/4) - Math.floor(y/100) + Math.floor(y/400) - 32045; }
function jd2islamic(jd){
  const l = jd - 1948440 + 10632;
  const n = Math.floor((l - 1) / 10631);
  let l2 = l - 10631*n + 354;
  const j = (Math.floor((10985 - l2)/5316)) * (Math.floor((50*l2)/17719)) + (Math.floor(l2/5670)) * (Math.floor((43*l2)/15238));
  l2 = l2 - (Math.floor((30 - j)/15)) * (Math.floor((17719*j)/50)) - (Math.floor(j/16)) * (Math.floor((15238*j)/43)) + 29;
  const m = Math.floor((24*l2)/709);
  const d = l2 - Math.floor((709*m)/24);
  const y = 30*n + j - 30;
  return {y,m,d};
}
function formatHijriFromObj(h, civilWeekday){
  const day = Number(h.day||h.date?.split('-')[0]);
  const monthName = h?.month?.ar || HIJRI_MONTHS_AR[h?.month?.number||0] || '';
  const year = h.year || (h.date? h.date.split('-')[2] : '');
  return `${civilWeekday}ØŒ ${day} ${monthName} ${year} Ù‡Ù€`;
}

/* ========================= Ø£Ø­Ø§Ø¯ÙŠØ« ========================= */
(function setHadith(){
  const h=HADITHS[Math.floor(Math.random()*HADITHS.length)];
  hadithText.textContent=h.t; hadithSource.textContent=h.s;
})();

/* ========================= Ù…Ù†Ø§Ø³Ø¨Ø§Øª (Ù…Ø®ØªØµØ±) ========================= */
const EVENTS={
  "1-10":[{t:"Ø¹Ø§Ø´ÙˆØ±Ø§Ø¡ â€“ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³ÙŠÙ† Ø¹"}],
  "2-20":[{t:"Ø§Ù„Ø£Ø±Ø¨Ø¹ÙŠÙ† â€“ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ø§Ù„Ø­Ø³ÙŠÙ† Ø¹"}],
  "7-27":[{t:"Ø§Ù„Ù…Ø¨Ø¹Ø« Ø§Ù„Ù†Ø¨ÙˆÙŠ"}],
  "10-1":[{t:"Ø¹ÙŠØ¯ Ø§Ù„ÙØ·Ø± Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ"}],
  "12-10":[{t:"Ø¹ÙŠØ¯ Ø§Ù„Ø£Ø¶Ø­Ù‰ Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ"}],
  "12-18":[{t:"Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯ÙŠØ±"}]
};
function drawEvents(todayM,todayD,nightM,nightD){
  const box=document.getElementById('eventsBox');
  const colToday=document.getElementById('colToday');
  const colNight=document.getElementById('colNight');
  const todayEl=document.getElementById('eventsToday');
  const nightEl=document.getElementById('eventsTonight');

  const todayList = EVENTS[`${todayM}-${todayD}`] || [];
  const nightList = EVENTS[`${nightM}-${nightD}`] || [];

  if(!todayList.length && !nightList.length){
    box.style.display='none'; todayEl.innerHTML=""; nightEl.innerHTML=""; return;
  }
  box.style.display='block';
  if(todayList.length){
    colToday.style.display='block';
    todayEl.innerHTML = todayList.map(e=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`).join("");
  }else{ colToday.style.display='none'; todayEl.innerHTML=""; }
  if(nightList.length){
    colNight.style.display='block';
    nightEl.innerHTML = nightList.map(e=>`<div class="evtItem"><span class="evtText">${e.t}</span></div>`).join("");
  }else{ colNight.style.display='none'; nightEl.innerHTML=""; }
}

/* ========================= Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª) ========================= */
async function fetchTimingsByCoords(lat,lon){
  const url=`https://api.aladhan.com/v1/timings?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&method=0&iso8601=true&adjustment=${encodeURIComponent(HIJRI_OFFSET_DAYS||0)}`;
  const r=await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª");
  const j=await r.json();
  const data=j?.data;
  if(!data?.timings) throw new Error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©");
  return data; // ÙŠØ­ØªÙˆÙŠ timings Ùˆ date Ùˆ meta.timezone
}

/* ======= Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ======= */
function nextKey(t, tz){
  const order=["Imsak","Fajr","Sunrise","Dhuhr","Asr","Sunset","Maghrib","Isha","Midnight"];
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  const {Y,M,D}=ymdInTZ(nowTZ, tz);
  const cand=order.map(k=>{
    const raw=(t[k]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
    if(!/^\d{1,2}:\d{2}$/.test(raw)) return {k,diff:Infinity};
    let [HH,MM]=raw.split(':').map(Number); HH=(HH===24)?0:HH;
    return {k,diff:new Date(+Y,+M-1,+D,HH||0,MM||0,0)-nowTZ};
  });
  let n=cand.filter(x=>x.diff>=0).sort((a,b)=>a.diff-b.diff)[0];
  if(!n) n=cand.sort((a,b)=>Math.abs(a.diff)-Math.abs(b.diff))[0];
  return n?.k||null;
}
function dateForKeyToday(tz, timings, key){
  const nowTZ=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  const {Y,M,D}=ymdInTZ(nowTZ, tz);
  const raw=(timings[key]||"").replace(/\s*\(.*?\)\s*/g,"").trim();
  if(!/^\d{1,2}:\d{2}$/.test(raw)) return null;
  let [H,Min]=raw.split(':').map(Number); H=(H===24)?0:H;
  return new Date(+Y,+M-1,+D,H||0,Min||0,0);
}
function ensureImsak(t){
  if(!t.Imsak && t.Fajr){
    const pure=String(t.Fajr).replace(/\s*\(.*?\)\s*/g,"").trim();
    let [H,M]=pure.split(":").map(Number);
    const d=new Date(); d.setHours((H||0), (M||0)-10, 0, 0);
    t.Imsak = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
  }
  return t;
}
function setCD(ms){
  ms = Math.max(0, ms|0);
  let s = Math.floor(ms/1000);
  const h = Math.floor(s/3600); s%=3600;
  const m = Math.floor(s/60); s%=60;
  cdH.textContent = String(h).padStart(2,'0');
  cdM.textContent = String(m).padStart(2,'0');
  cdS.textContent = String(s).padStart(2,'0');
}
function tickCountdown(target,key){
  const tz = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
  const now=new Date(new Date().toLocaleString('en-US',{timeZone:tz}));
  const diff = target - now;
  setCD(diff);
  if(diff<=0){ clearInterval(cdTimer); load(); }
}

/* ========================= Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ========================= */
async function render(data){
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù…Ù† Aladhan meta
  if(data?.meta?.timezone) state.tz = data.meta.timezone;

  let t = ensureImsak({...data.timings});
  lastTimings = t;

  const rows=[
    {n:"Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ",k:"Imsak"},
    {n:"Ø£Ø°Ø§Ù† Ø§Ù„ÙØ¬Ø±",k:"Fajr"},
    {n:"Ø§Ù„Ø´Ø±ÙˆÙ‚",k:"Sunrise"},
    {n:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¸Ù‡Ø±",k:"Dhuhr"},
    {n:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹ØµØ±",k:"Asr"},
    {n:"Ø§Ù„ØºØ±ÙˆØ¨",k:"Sunset"},
    {n:"Ø£Ø°Ø§Ù† Ø§Ù„Ù…ØºØ±Ø¨",k:"Maghrib"},
    {n:"Ø£Ø°Ø§Ù† Ø§Ù„Ø¹Ø´Ø§Ø¡",k:"Isha"},
    {n:"Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„",k:"Midnight"}
  ];
  const k=nextKey(t,state.tz);
  times.innerHTML=rows.map(r=>`<tr class="${r.k===k?'next':''}"><td class="name">${r.n}</td><td class="time">${to12h(t[r.k])}</td></tr>`).join("");

  // ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ù‚Ø§Ø¯Ù…
  const target = dateForKeyToday(state.tz, t, k);
  nextName.textContent = NAMES[k] || k || "--";
  nextAt.textContent = to12h(t[k]||'--:--');
  nextNote.textContent = (k==="Sunrise" ? "Ø²Ù…Ù† Ø§Ù„Ø´Ø±ÙˆÙ‚" : k==="Sunset" ? "ÙˆÙ‚Øª Ø§Ù„ØºØ±ÙˆØ¨" : "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ");
  if(cdTimer) clearInterval(cdTimer);
  if(target) { cdTimer = setInterval(()=>tickCountdown(target,k),1000); tickCountdown(target,k); }

  // Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  const nowTZ = new Date(new Date().toLocaleString('en-US',{timeZone:state.tz}));
  greg.textContent = new Intl.DateTimeFormat('ar',{timeZone:state.tz,weekday:'long',year:'numeric',month:'long',day:'numeric'}).format(nowTZ);

  // Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© (Ù…Ø¹ Ø§Ù„ØªØ¹ÙˆÙŠØ¶)
  try{
    const h = data?.date?.hijri;
    if(h){ 
      const wd = new Intl.DateTimeFormat('ar',{timeZone:state.tz,weekday:'long'}).format(nowTZ);
      hijri.textContent = formatHijriFromObj(h, wd);
      // Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ù„ÙŠÙ„Ø©
      const todayM = Number(h?.month?.number||0), todayD=Number(h?.day||0);
      // Ø§Ø­Ø³Ø¨ Ù„ÙŠÙ„Ø© Ø§Ù„ØºØ¯
      const refTonight = new Date(nowTZ.getTime()+86400000);
      const wd2 = new Intl.DateTimeFormat('ar',{timeZone:state.tz,weekday:'long'}).format(refTonight);
      let h2 = h; // Ø§ÙØªØ±Ø§Ø¶ÙŠ
      try{
        const d2 = await fetch(`https://api.aladhan.com/v1/gToH?date=${encodeURIComponent(new Intl.DateTimeFormat('en-GB',{timeZone:state.tz,day:'2-digit',month:'2-digit',year:'numeric'}).format(refTonight).replace(/\//g,'-'))}&adjustment=${encodeURIComponent(HIJRI_OFFSET_DAYS||0)}`).then(x=>x.json());
        h2 = d2?.data?.hijri || h;
      }catch{}
      const nightM = Number(h2?.month?.number||0), nightD=Number(h2?.day||0);
      drawEvents(todayM,todayD,nightM,nightD);
    }else{ throw 0; }
  }catch{
    // fallback Ù…Ø­Ù„ÙŠ
    const civilWeekday = new Intl.DateTimeFormat('ar',{timeZone:state.tz,weekday:'long'}).format(nowTZ);
    try{
      const parts=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{timeZone:state.tz,year:'numeric',month:'numeric',day:'numeric'}).formatToParts(nowTZ);
      const y=+parts.find(p=>p.type==='year').value, m=+parts.find(p=>p.type==='month').value, d=+parts.find(p=>p.type==='day').value;
      hijri.textContent = `${civilWeekday}ØŒ ${d} ${HIJRI_MONTHS_AR[m]} ${y} Ù‡Ù€`;
    }catch{
      const {Y,M,D}=ymdInTZ(nowTZ,state.tz);
      const h=jd2islamic(g2jd(+Y,+M,+D));
      hijri.textContent = `${civilWeekday}ØŒ ${h.d} ${HIJRI_MONTHS_AR[h.m]} ${h.y} Ù‡Ù€`;
    }
  }
}

/* ========================= ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø§Ø³ÙŠ ========================= */
function setPlaceTexts(){
  place.textContent = state.nameAr || state.nameEn || `${state.lat.toFixed(4)}, ${state.lon.toFixed(4)}`;
  subPlace.textContent = `${state.lat.toFixed(4)}, ${state.lon.toFixed(4)} â€¢ ${state.tz||Intl.DateTimeFormat().resolvedOptions().timeZone}`;
}
async function load(){
  setPlaceTexts();
  hijri.textContent="--";
  greg.textContent="â€”";
  times.innerHTML="<tr><td colspan=2>...</td></tr>";
  try{
    const data=await fetchTimingsByCoords(state.lat,state.lon);
    await render(data);
  }catch(e){
    times.innerHTML=`<tr><td colspan="2" style="color:#b91c1c">ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª.</td></tr>`;
    document.getElementById('eventsBox').style.display='none';
  }
}
load();

/* ========================= ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ========================= */
async function reverseGeocode(lat,lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=ar,en`;
  const r = await fetch(url,{headers:{'Accept-Language':'ar,en'}});
  if(!r.ok) throw new Error("ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø¹ÙƒØ³ÙŠ");
  const j = await r.json();
  const dispAr = j?.display_name || "";
  // Ø§Ø³Ù… Ø¹Ø±Ø¨ÙŠ/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù…Ø¨Ø³Ù‘Ø·
  const city = j?.address?.city || j?.address?.town || j?.address?.village || j?.address?.municipality || j?.address?.state || "";
  const country = j?.address?.country || "";
  return {
    nameAr: `${city||dispAr}ØŒ ${country}`.replace(/^ØŒ\s*/,''),
    nameEn: j?.namedetails?.name || dispAr,
  };
}
document.getElementById('useGeo').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹."); return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude:lat, longitude:lon} = pos.coords;
    try{
      const data = await fetchTimingsByCoords(lat,lon);
      const metaName = await reverseGeocode(lat,lon).catch(()=>({nameAr:`Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (${lat.toFixed(3)}, ${lon.toFixed(3)})`, nameEn:""}));
      state = { ...state, lat, lon, tz: (data?.meta?.timezone||state.tz), nameAr:metaName.nameAr, nameEn:metaName.nameEn };
      localStorage.setItem("pr_times_state", JSON.stringify(state));
      await render(data); setPlaceTexts();
    }catch{ alert("ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹."); }
  }, err=>{ alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹."); });
});

/* ========================= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© ========================= */
const modal=document.getElementById("modal");
const openPicker=document.getElementById("openPicker");
const closePicker=document.getElementById("closePicker");
const clearSaved=document.getElementById("clearSaved");
const q=document.getElementById("q");
const results=document.getElementById("results");
const hijriOffsetSel=document.getElementById("hijriOffsetSel");
openPicker.addEventListener('click', ()=>{ hijriOffsetSel.value=String(HIJRI_OFFSET_DAYS); modal.classList.add('open'); document.body.style.overflow='hidden'; q.focus(); results.innerHTML=""; });
closePicker.addEventListener('click', ()=>{ modal.classList.remove('open'); document.body.style.overflow=''; });
modal.addEventListener('click', (e)=>{ if(e.target===modal) { modal.classList.remove('open'); document.body.style.overflow=''; }});
clearSaved.addEventListener('click', ()=>{ localStorage.removeItem('pr_times_state'); alert("ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸."); });

hijriOffsetSel.addEventListener('change', ()=>{
  HIJRI_OFFSET_DAYS = Number(hijriOffsetSel.value||"0");
  localStorage.setItem("pr_hijri_offset_days", String(HIJRI_OFFSET_DAYS));
  load();
});

let searchTimer=null;
function debounceSearch(){
  clearTimeout(searchTimer);
  const term = q.value.trim();
  if(!term){ results.innerHTML=""; return; }
  searchTimer = setTimeout(()=>search(term), 500);
}
q.addEventListener('input', debounceSearch);

async function search(term){
  // Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
  const m = term.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
  if(m){
    const lat = parseFloat(m[1]), lon=parseFloat(m[3]);
    results.innerHTML = renderCoordsOption(lat,lon);
    return;
  }
  results.innerHTML = `<div class="resItem">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«â€¦</div>`;
  try{
    const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(term)}&addressdetails=1&accept-language=ar,en&limit=10`;
    const r=await fetch(url,{headers:{'Accept-Language':'ar,en'}});
    if(!r.ok) throw 0;
    const arr=await r.json();
    if(!arr.length){ results.innerHTML=`<div class="resItem">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.</div>`; return; }
    results.innerHTML = arr.map(item=>{
      const title = item.display_name;
      const lat = Number(item.lat), lon=Number(item.lon);
      const city = item.address?.city || item.address?.town || item.address?.village || item.address?.state || "";
      const country = item.address?.country || "";
      const cap = (city? `${city}ØŒ ${country}` : title);
      return `<div class="resItem" data-lat="${lat}" data-lon="${lon}" data-title="${cap.replace(/"/g,'&quot;')}">
        <div class="resCap">${cap}</div>
        <div class="resSub">${title}</div>
      </div>`;
    }).join("");
  }catch{
    results.innerHTML = `<div class="resItem">ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø­Ø«.</div>`;
  }
}
function renderCoordsOption(lat,lon){
  return `<div class="resItem" data-lat="${lat}" data-lon="${lon}" data-title="Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (${lat.toFixed(4)}, ${lon.toFixed(4)})">
    <div class="resCap">Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©</div>
    <div class="resSub">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>
  </div>`;
}
results.addEventListener('click', async (e)=>{
  const item = e.target.closest('.resItem'); if(!item) return;
  const lat = Number(item.dataset.lat), lon=Number(item.dataset.lon);
  try{
    const data = await fetchTimingsByCoords(lat,lon);
    // Ø­Ø§ÙˆÙ„ ØªØ³Ù…ÙŠØ© Ø¹Ø±Ø¨ÙŠØ© Ø¬Ù…ÙŠÙ„Ø©
    let title = item.dataset.title || `Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (${lat.toFixed(3)}, ${lon.toFixed(3)})`;
    try{
      const rev = await reverseGeocode(lat,lon);
      title = rev.nameAr || title;
    }catch{}
    state = { ...state, lat, lon, tz: (data?.meta?.timezone||state.tz), nameAr:title, nameEn:title };
    localStorage.setItem("pr_times_state", JSON.stringify(state));
    await render(data); setPlaceTexts();
    modal.classList.remove('open'); document.body.style.overflow='';
  }catch{ alert("ØªØ¹Ø°Ù‘Ø± Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹."); }
});

/* ========================= Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…Ø­ÙÙˆØ¸ ========================= */
(async function initOnce(){
  // Ù„Ùˆ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø¬Ø±Ù‘Ø¨ Ø£Ø®Ø° Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
  if(!localStorage.getItem("pr_times_state") && navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const {latitude:lat, longitude:lon} = pos.coords;
      try{
        const data = await fetchTimingsByCoords(lat,lon);
        const metaName = await reverseGeocode(lat,lon).catch(()=>({nameAr:`Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (${lat.toFixed(3)}, ${lon.toFixed(3)})`}));
        state = { ...state, lat, lon, tz:(data?.meta?.timezone||state.tz), nameAr:metaName.nameAr };
        localStorage.setItem("pr_times_state", JSON.stringify(state));
        await render(data); setPlaceTexts();
      }catch{}
    }, ()=>{ /* ØªØ¬Ø§Ù‡Ù„ */ }, {enableHighAccuracy:true, timeout:8000});
  }
})();

/* ========================= ØªØ­Ø³ÙŠÙ†Ø§Øª ØµØºÙŠØ±Ø© ========================= */
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible'){ load(); }});
</script>
</body>
</html>
